<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallagher Australia ESG & Flood Risk Dashboard</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <!-- CSS Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css">
    <link rel="stylesheet" href="chatbot.css">
    
    <!-- JavaScript Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.geometryutil@0.9.3/dist/leaflet.geometryutil.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="data_time_functions.js"></script>
    <script src="chatbot.js"></script>
    <script src="flood_functions.js"></script>
    
    <!-- Error handling for asynchronous operations -->
    <script>
    window.addEventListener('error', function(e) {
        console.log('Global error handler:', e.message);
    });
    
    window.addEventListener('unhandledrejection', function(e) {
        console.log('Unhandled Promise rejection:', e.reason);
    });
    </script>
    
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6ec6ff;
            --tertiary-color: #4b4da1;
            --highlight-color: #00bcd4;
            --dark-color: #333;
            --light-color: #f8f9fa;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }
        
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--dark-color);
            overflow: hidden;
        }
        
        #map {
            height: 100vh;
            width: 100%;
            z-index: 1;
        }
        
        /* Top navigation bar */
        .top-nav {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 15px;
        }
        
        .logo {
            font-weight: bold;
            font-size: 20px;
            margin-right: 20px;
            color: var(--primary-color);
        }

        .custom-navbar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 30px;
            padding: 8px 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 80%;
            text-align: center;
        }
        
        .custom-navbar h1 {
            margin: 0;
            color: #0d6efd;
            font-size: 24px;
            font-weight: 600;
        }
        
        /* Control buttons */
        .control-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-btn {
            width: 50px;
            height: 50px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            color: #333;
            font-size: 18px;
        }
        
        .control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .control-btn.active {
            background-color: #0d6efd;
            color: white;
        }
        
        /* Layer control panel */
        .layer-panel {
            position: absolute;
            top: 70px;
            right: 10px;
            z-index: 1000;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            cursor: move;
        }
        
        .layer-header {
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .layer-content {
            padding: 15px;
        }
        
        .layer-item {
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .layer-item:last-child {
            border-bottom: none;
        }
        
        .layer-info-btn {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        
        /* Filter panel */
        .filter-panel {
            position: absolute;
            top: 70px;
            left: 10px;
            z-index: 1000;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            cursor: move;
        }
        
        .filter-header {
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
        }
        
        .filter-content {
            padding: 15px;
        }
        
        .filter-group {
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .filter-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .filter-label {
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
        }
        
        .filter-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .filter-select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .filter-checkbox {
            margin-right: 5px;
        }
        
        .filter-range {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .filter-values {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .filter-button {
            width: 100%;
            padding: 8px 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            margin-top: 10px;
        }
        
        /* ESG Panel Styles */
        .panel {
            position: absolute;
            z-index: 1000;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.15);
            overflow: hidden;
            transition: all 0.3s ease;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .esg-panel {
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.95);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
            box-shadow: none;
            border-radius: 0;
            overflow-y: auto;
            z-index: 1500;
        }
        
        .esg-panel.active {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }
        
        .flood-panel {
            bottom: -400px;
            left: 20px;
            width: 350px;
            max-height: 350px;
        }
        
        .flood-panel.active {
            bottom: 20px;
        }
        
        .panel-header {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #212529;
        }
        
        .panel-header .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6c757d;
        }
        
        .panel-header .close-btn:hover {
            color: #dc3545;
        }
        
        .panel-content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }
        
        .esg-panel .panel-content {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }
        
        .esg-panel .panel-header {
            background-color: #0d6efd;
            color: white;
            padding: 15px 30px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .esg-panel .panel-header h2 {
            color: white;
            font-size: 24px;
        }
        
        .esg-panel .panel-header .close-btn {
            color: white;
            font-size: 24px;
            background-color: rgba(255, 255, 255, 0.2);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .esg-panel .panel-header .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
        }
        
        .esg-grid-item {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 20px;
        }
        
        .esg-grid-item.full-width {
            grid-column: 1 / -1;
        }
        
        .esg-grid-item h3 {
            font-size: 20px;
            margin-bottom: 20px;
        }
        
        /* Pulsing marker animation for engineering report */
        @keyframes pulse {
            0% {
                transform: scale(0.5);
                opacity: 0.8;
            }
            70% {
                transform: scale(2);
                opacity: 0;
            }
            100% {
                transform: scale(0.5);
                opacity: 0;
            }
        }
        
        .pulse-marker {
            width: 30px;
            height: 30px;
            background-color: rgba(220, 53, 69, 0.4);
            border-radius: 50%;
            position: relative;
            animation: pulse 1.5s infinite;
        }
        
        .pulse-marker:after {
            content: '';
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: rgba(220, 53, 69, 1);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
        }
        
        .toast {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        /* Time slider */
        .time-slider-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 600px;
            cursor: move;
        }
        
        .time-slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .time-slider-title {
            font-weight: 600;
            margin: 0;
        }
        
        .time-slider {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .time-slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        
        /* Enhanced time slider and data panel styles */
        .time-range-label {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }
        
        .file-section {
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .file-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        
        .visualization-options {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Main Navigation Bar -->
    <div class="custom-navbar">
        <h1><i class="fas fa-water me-2"></i> Gallagher Australia ESG & Flood Risk Dashboard</h1>
    </div>
    
    <!-- Control Buttons -->
    <div class="control-buttons">
        <button class="control-btn" id="esg-btn" title="ESG Analysis">
            <i class="fas fa-chart-line"></i>
        </button>
        <button class="control-btn" id="layer-btn" title="Layer Control">
            <i class="fas fa-layer-group"></i>
        </button>
        <button class="control-btn" id="filter-btn" title="Filter Data">
            <i class="fas fa-filter"></i>
        </button>
        <button class="control-btn" id="time-btn" title="Time Slider">
            <i class="fas fa-calendar-alt"></i>
        </button>
        <button class="control-btn" id="data-btn" title="Load Data Files">
            <i class="fas fa-file-upload"></i>
        </button>
        <button class="control-btn" id="weather-btn" title="Weather & Climate">
            <i class="fas fa-cloud-sun-rain"></i>
        </button>
        <button class="control-btn" id="export-btn" title="Export Reports & Data">
            <i class="fas fa-file-export"></i>
        </button>
        <button class="control-btn" id="measurement-btn" title="Measurement Tools">
            <i class="fas fa-ruler-combined"></i>
        </button>
        <button class="control-btn" id="compare-btn" title="Compare Scenarios">
            <i class="fas fa-code-compare"></i>
        </button>
        <button class="control-btn" id="fullscreen-btn" title="Toggle Fullscreen">
            <i class="fas fa-expand"></i>
        </button>
    </div>
    
    <!-- Main Map Container -->
    <div id="map"></div>
    
    <!-- Layer Panel -->
    <div class="layer-panel" id="layer-panel" style="display: none;">
        <div class="layer-header">
            <h4>Data Layers</h4>
            <button class="layer-info-btn" id="layer-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="layer-content">
            <div class="layer-item">
                <div class="layer-header">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="events-visibility" checked>
                        <label class="form-check-label" for="events-visibility">Weather Events</label>
                    </div>
                </div>
            </div>
            <div class="layer-item">
                <div class="layer-header">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="daily-rainfall-visibility">
                        <label class="form-check-label" for="daily-rainfall-visibility">Daily Rainfall</label>
                    </div>
                </div>
            </div>
            <div class="layer-item">
                <div class="layer-header">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="12month-rainfall-visibility">
                        <label class="form-check-label" for="12month-rainfall-visibility">12-Month Rainfall</label>
                    </div>
                </div>
            </div>
            <div class="layer-item">
                <div class="layer-header">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="36month-rainfall-visibility">
                        <label class="form-check-label" for="36month-rainfall-visibility">36-Month Rainfall</label>
                    </div>
                </div>
            </div>
            <div class="layer-item">
                <div class="layer-header">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="custom-locations-visibility" checked>
                        <label class="form-check-label" for="custom-locations-visibility">Custom Locations</label>
                    </div>
                </div>
            </div>
            <div class="layer-item">
                <div class="layer-header">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="flood-warnings-visibility" checked>
                        <label class="form-check-label" for="flood-warnings-visibility">Flood Warnings</label>
                    </div>
                </div>
            </div>
            <div class="layer-item">
                <div class="layer-header">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="flood-polygons-visibility" checked>
                        <label class="form-check-label" for="flood-polygons-visibility">Flood Polygons</label>
                    </div>
                </div>
            </div>
            <div class="layer-item">
                <div class="layer-header">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="heatmap-visibility">
                        <label class="form-check-label" for="heatmap-visibility">Rainfall Heatmap</label>
                    </div>
                </div>
            </div>
            <div class="layer-item">
                <div class="layer-header">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="risk-visibility">
                        <label class="form-check-label" for="risk-visibility">Risk Assessment Layer</label>
                    </div>
                </div>
            </div>
            <!-- Additional layer options can be added here -->
        </div>
    </div>
    
    <!-- Filter Panel -->
    <div class="filter-panel" id="filter-panel" style="display: none;">
        <div class="filter-header">
            <h4>Filter Data</h4>
            <button class="layer-info-btn" id="filter-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="filter-content">
            <div class="filter-group">
                <label class="filter-label">Date Range</label>
                <input type="date" id="start-date" class="filter-input" placeholder="Start Date">
                <input type="date" id="end-date" class="filter-input" placeholder="End Date">
            </div>
            <div class="filter-group">
                <label class="filter-label">Region</label>
                <select id="region-filter" class="filter-select">
                    <option value="all">All Regions</option>
                    <option value="qld">Queensland</option>
                    <option value="nsw">New South Wales</option>
                    <option value="vic">Victoria</option>
                    <option value="wa">Western Australia</option>
                    <option value="sa">South Australia</option>
                    <option value="tas">Tasmania</option>
                    <option value="nt">Northern Territory</option>
                    <option value="act">Australian Capital Territory</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Event Type</label>
                <div class="form-check">
                    <input class="form-check-input filter-checkbox" type="checkbox" id="type-flood" checked>
                    <label class="form-check-label" for="type-flood">Flood</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input filter-checkbox" type="checkbox" id="type-cyclone" checked>
                    <label class="form-check-label" for="type-cyclone">Cyclone</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input filter-checkbox" type="checkbox" id="type-fire" checked>
                    <label class="form-check-label" for="type-fire">Bushfire</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input filter-checkbox" type="checkbox" id="type-storm" checked>
                    <label class="form-check-label" for="type-storm">Severe Storm</label>
                </div>
            </div>
            <div class="filter-group">
                <label class="filter-label">Severity</label>
                <input type="range" id="severity-filter" class="filter-range" min="1" max="5" value="1">
                <div class="filter-values">
                    <span>Low</span>
                    <span>High</span>
                </div>
            </div>
            <button id="apply-filters" class="filter-button">Apply Filters</button>
            <button id="reset-filters" class="filter-button mt-2" style="background-color: #6c757d;">Reset Filters</button>
        </div>
    </div>
    
    <!-- ESG Analysis Panel -->
    <div class="panel esg-panel" id="esg-panel">
        <div class="panel-header">
            <h2><i class="fas fa-chart-line me-2"></i> Gallagher Climate & Sustainability Dashboard</h2>
            <button class="close-btn" id="esg-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="panel-content">
            <!-- Overview Rating - Full Width -->
            <div class="esg-grid-item full-width">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <h3>Climate Risk Overview</h3>
                        <p>Comprehensive assessment of flood risk metrics based on Bureau of Meteorology data across Australian regions.</p>
                        <div class="d-flex justify-content-between mt-4">
                            <div class="text-center">
                                <h5>Physical Risk</h5>
                                <div class="position-relative d-inline-block">
                                    <canvas id="physical-risk-gauge" width="120" height="120"></canvas>
                                    <div class="position-absolute top-50 start-50 translate-middle">
                                        <h3 class="mb-0" id="physical-risk-value">74%</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center">
                                <h5>Transition Risk</h5>
                                <div class="position-relative d-inline-block">
                                    <canvas id="transition-risk-gauge" width="120" height="120"></canvas>
                                    <div class="position-absolute top-50 start-50 translate-middle">
                                        <h3 class="mb-0" id="transition-risk-value">52%</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center">
                                <h5>Regulatory Risk</h5>
                                <div class="position-relative d-inline-block">
                                    <canvas id="regulatory-risk-gauge" width="120" height="120"></canvas>
                                    <div class="position-absolute top-50 start-50 translate-middle">
                                        <h3 class="mb-0" id="regulatory-risk-value">38%</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <canvas id="risk-factors-radar" height="200"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Current Flood Risk -->
            <div class="esg-grid-item">
                <h3>Current Flood Risk</h3>
                <p>Based on recent flood warnings and historical data</p>
                <div class="mt-3">
                    <canvas id="flood-risk-chart" height="250"></canvas>
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <span class="badge bg-danger p-2">5 Active Warnings</span>
                    <span class="badge bg-warning text-dark p-2">3 Potential Risk Areas</span>
                    <span class="badge bg-info p-2">2 Monitoring Zones</span>
                </div>
            </div>
            
            <!-- Insurance Impact -->
            <div class="esg-grid-item">
                <h3>Insurance Impact</h3>
                <p>Estimated effect on premiums and coverage</p>
                <div class="mt-3">
                    <canvas id="insurance-impact-chart" height="250"></canvas>
                </div>
                <div class="alert alert-primary mt-3">
                    <strong>Recommendations:</strong> Consider enhanced flood coverage in high-risk zones identified by the dashboard.
                </div>
            </div>
            
            <!-- Historical Comparison -->
            <div class="esg-grid-item">
                <h3>Historical Comparison</h3>
                <p>Rainfall and flood events from 1980-2025</p>
                <div class="mt-3 mb-2">
                    <div class="form-group">
                        <label for="historical-metric" class="mb-2">Metric:</label>
                        <select class="form-select" id="historical-metric">
                            <option value="frequency">Event Frequency</option>
                            <option value="intensity">Event Intensity</option>
                            <option value="duration">Event Duration</option>
                            <option value="damage">Economic Impact</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <canvas id="historical-chart" height="250"></canvas>
                </div>
            </div>
            
            <!-- Regional Impact Analysis (Interactive) -->
            <div class="esg-grid-item full-width mt-3">
                <h3>Regional Engineering Assessment</h3>
                <p>Analyze specific regions for detailed flood risk assessment and generate engineering reports.</p>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                Set Analysis Parameters
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="analysis-region" class="form-label">Region</label>
                                    <select id="analysis-region" class="form-select">
                                        <option value="qld">Queensland</option>
                                        <option value="nsw">New South Wales</option>
                                        <option value="vic">Victoria</option>
                                        <option value="wa">Western Australia</option>
                                        <option value="national">National</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="risk-level" class="form-label">Risk Level</label>
                                    <select id="risk-level" class="form-select">
                                        <option value="high">High</option>
                                        <option value="medium">Medium</option>
                                        <option value="low">Low</option>
                                        <option value="all">All Risk Levels</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="time-scenario" class="form-label">Time Scenario</label>
                                    <select id="time-scenario" class="form-select">
                                        <option value="current">Current (2025)</option>
                                        <option value="2030">Projection (2030)</option>
                                        <option value="2050">Projection (2050)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="visualization-type" class="form-label">Visualization Type</label>
                                    <select id="visualization-type" class="form-select">
                                        <option value="heatmap">Heatmap</option>
                                        <option value="markers">Markers</option>
                                        <option value="icons">Icons</option>
                                    </select>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="apply-to-main" checked>
                                    <label class="form-check-label" for="apply-to-main">
                                        Apply to Main Map when closing panel
                                    </label>
                                </div>
                                
                                <button id="generate-report" class="btn btn-primary w-100">Generate Engineering Report</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                Risk Visualization Preview
                            </div>
                            <div class="card-body p-0 d-flex flex-column">
                                <div id="mini-map" style="height: 300px; width: 100%;"></div>
                                <div class="p-3 bg-light mt-auto" id="region-stats">
                                    <h5>Regional Statistics</h5>
                                    <div id="region-stats-content">
                                        <p class="text-muted">Select parameters to generate statistics</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Time Slider -->
    <div class="time-slider-container" id="time-slider-container">
        <div class="time-slider-header">
            <h5 class="time-slider-title">Time Range</h5>
            <button class="btn-close" id="time-slider-close"></button>
        </div>
        <input type="range" id="time-slider" class="time-slider" min="0" max="100" value="100">
        <div class="time-slider-labels">
            <span>Jan 2025</span>
            <span>Feb 2025</span>
            <span>Mar 2025</span>
            <span>Apr 2025</span>
        </div>
        <div class="d-flex justify-content-center align-items-center mt-2">
            <span id="current-date" class="badge bg-primary me-3">April 1, 2025</span>
            <button id="play-time-btn" class="btn btn-primary btn-sm rounded-circle" style="width: 36px; height: 36px;">
                <i class="fas fa-play"></i>
            </button>
        </div>
    </div>
    
    <!-- Data Files Panel -->
    <div class="panel filter-panel" id="data-panel" style="display: none; top: 160px;">
        <div class="filter-header">
            <h4>Load Data Files</h4>
            <button class="layer-info-btn" id="data-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="filter-content">
            <div class="mb-3">
                <label for="rainfall-data" class="form-label">Rainfall Data (CSV)</label>
                <input class="form-control" type="file" id="rainfall-data" accept=".csv">
                <small class="text-muted">Upload rainfall.2025-03-31.12month.aus.csv</small>
            </div>
            <div class="mb-3">
                <label for="historical-data" class="form-label">Historical Events (CSV)</label>
                <input class="form-control" type="file" id="historical-data" accept=".csv">
                <small class="text-muted">Upload 1980-2025.csv</small>
            </div>
            <div class="mb-3">
                <label for="flood-warnings" class="form-label">Flood Warnings (JSON)</label>
                <input class="form-control" type="file" id="flood-warnings" accept=".json">
                <small class="text-muted">Upload flood_warnings.json</small>
            </div>
            <div class="mb-3">
                <label for="flood-polygons" class="form-label">Flood Polygons (GeoJSON)</label>
                <input class="form-control" type="file" id="flood-polygons" accept=".json,.geojson">
                <small class="text-muted">Upload flood_warning_polygons.json</small>
            </div>
            <button id="process-files" class="filter-button">Process Files</button>
        </div>
    </div>
    
    <!-- Export Panel -->
    <div class="panel filter-panel" id="export-panel" style="display: none; top: 180px; left: 60px;">
        <div class="filter-header">
            <h4>Export Reports & Data</h4>
            <button class="layer-info-btn" id="export-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="filter-content">
            <div class="mb-3">
                <h5 class="mb-3">Engineering Reports</h5>
                <button id="export-current-report" class="btn btn-primary w-100 mb-2">
                    <i class="fas fa-file-pdf me-2"></i>Export Current Report (PDF)
                </button>
                <button id="export-region-report" class="btn btn-outline-primary w-100">
                    <i class="fas fa-file-word me-2"></i>Export Region Report (DOCX)
                </button>
            </div>
            <div class="mb-3">
                <h5 class="mb-3">Map Data</h5>
                <button id="export-screenshot" class="btn btn-success w-100 mb-2">
                    <i class="fas fa-camera me-2"></i>Export Map Screenshot
                </button>
                <button id="export-geojson" class="btn btn-outline-success w-100">
                    <i class="fas fa-map me-2"></i>Export Visible Layers (GeoJSON)
                </button>
            </div>
            <div class="mb-3">
                <h5 class="mb-3">ESG Data</h5>
                <button id="export-esg-report" class="btn btn-info w-100 mb-2 text-white">
                    <i class="fas fa-chart-pie me-2"></i>Export ESG Analytics Report
                </button>
                <button id="export-csv" class="btn btn-outline-info w-100">
                    <i class="fas fa-file-csv me-2"></i>Export Data as CSV
                </button>
            </div>
        </div>
    </div>
    
    <!-- Measurement Tools Panel -->
    <div class="panel filter-panel" id="measurement-panel" style="display: none; top: 200px; left: 120px;">
        <div class="filter-header">
            <h4>Measurement Tools</h4>
            <button class="layer-info-btn" id="measurement-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="filter-content">
            <div class="mb-3">
                <h5 class="mb-3">Distance & Area</h5>
                <button id="measure-distance" class="btn btn-primary w-100 mb-2">
                    <i class="fas fa-ruler me-2"></i>Measure Distance
                </button>
                <button id="measure-area" class="btn btn-outline-primary w-100 mb-2">
                    <i class="fas fa-draw-polygon me-2"></i>Measure Area
                </button>
                <button id="measure-clear" class="btn btn-danger w-100">
                    <i class="fas fa-trash-alt me-2"></i>Clear Measurements
                </button>
            </div>
            <div class="mb-3">
                <h5 class="mb-3">Location Information</h5>
                <div class="input-group mb-2">
                    <input type="text" id="lat-lng-input" class="form-control" placeholder="Lat, Lng">
                    <button id="go-to-location" class="btn btn-secondary">Go</button>
                </div>
                <div id="location-info" class="alert alert-info small" style="display: none;">
                    Click on map to see location information
                </div>
            </div>
        </div>
    </div>
    
    <!-- Weather & Climate Panel -->
    <div class="panel filter-panel" id="weather-panel" style="display: none; top: 120px; left: 140px; width: 400px;">
        <div class="filter-header">
            <h4><i class="fas fa-cloud-sun-rain me-2"></i>Weather & Climate</h4>
            <button class="layer-info-btn" id="weather-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="filter-content">
            <ul class="nav nav-tabs mb-3" id="weatherTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="current-tab" data-bs-toggle="tab" data-bs-target="#current-weather" 
                        type="button" role="tab" aria-controls="current-weather" aria-selected="true">Current</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="forecast-tab" data-bs-toggle="tab" data-bs-target="#forecast-weather" 
                        type="button" role="tab" aria-controls="forecast-weather" aria-selected="false">Forecast</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="climate-tab" data-bs-toggle="tab" data-bs-target="#climate-data" 
                        type="button" role="tab" aria-controls="climate-data" aria-selected="false">Climate</button>
                </li>
            </ul>
            
            <div class="tab-content">
                <!-- Current Weather Tab -->
                <div class="tab-pane fade show active" id="current-weather" role="tabpanel" aria-labelledby="current-tab">
                    <div class="d-flex justify-content-between mb-3">
                        <div class="input-group" style="max-width: 250px;">
                            <input type="text" id="weather-location" class="form-control" placeholder="City or coordinates">
                            <button class="btn btn-primary" id="get-weather">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <button class="btn btn-outline-primary" id="use-current-location">
                            <i class="fas fa-location-arrow"></i>
                        </button>
                    </div>
                    
                    <div id="current-weather-data" class="card mb-3" style="display: none;">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <div class="weather-icon me-3">
                                    <i class="fas fa-cloud-sun fa-3x text-primary"></i>
                                </div>
                                <div>
                                    <h5 id="weather-location-name" class="mb-0">Brisbane, QLD</h5>
                                    <div id="weather-timestamp" class="small text-muted">April 22, 2025 08:30 AM</div>
                                </div>
                                <div class="ms-auto">
                                    <div id="weather-temp" class="display-6">28°C</div>
                                </div>
                            </div>
                            
                            <div class="row text-center">
                                <div class="col-4">
                                    <div><i class="fas fa-tint text-primary"></i></div>
                                    <div id="weather-humidity" class="fw-bold">65%</div>
                                    <div class="small">Humidity</div>
                                </div>
                                <div class="col-4">
                                    <div><i class="fas fa-wind text-primary"></i></div>
                                    <div id="weather-wind" class="fw-bold">15 km/h</div>
                                    <div class="small">Wind</div>
                                </div>
                                <div class="col-4">
                                    <div><i class="fas fa-compress-alt text-primary"></i></div>
                                    <div id="weather-pressure" class="fw-bold">1012 hPa</div>
                                    <div class="small">Pressure</div>
                                </div>
                            </div>
                            
                            <hr class="my-3">
                            
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-sm btn-primary" id="show-weather-on-map">
                                    <i class="fas fa-map-marker-alt me-1"></i> Show on Map
                                </button>
                                <button class="btn btn-sm btn-outline-primary" id="add-to-flood-analysis">
                                    <i class="fas fa-chart-bar me-1"></i> Add to Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="weather-loading" class="text-center p-4" style="display: none;">
                        <div class="spinner-border text-primary mb-2" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>Fetching weather data...</div>
                    </div>
                    
                    <div id="weather-placeholder" class="alert alert-info">
                        Enter a location to view current weather data
                    </div>
                </div>
                
                <!-- Forecast Tab -->
                <div class="tab-pane fade" id="forecast-weather" role="tabpanel" aria-labelledby="forecast-tab">
                    <div id="forecast-data">
                        <h5>5-Day Forecast</h5>
                        <div id="forecast-cards" class="row row-cols-1 g-2">
                            <!-- Forecast cards will be generated here -->
                            <div class="col">
                                <div class="card">
                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-0">April 23</h6>
                                                <small class="text-muted">Wednesday</small>
                                            </div>
                                            <div><i class="fas fa-cloud fa-2x text-primary"></i></div>
                                            <div class="text-end">
                                                <div class="fw-bold">27° / 19°</div>
                                                <small>20% chance of rain</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="card">
                                    <div class="card-body p-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-0">April 24</h6>
                                                <small class="text-muted">Thursday</small>
                                            </div>
                                            <div><i class="fas fa-cloud-rain fa-2x text-primary"></i></div>
                                            <div class="text-end">
                                                <div class="fw-bold">25° / 18°</div>
                                                <small>70% chance of rain</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- More forecast days -->
                        </div>
                        
                        <h5 class="mt-3">Hourly Forecast</h5>
                        <div class="overflow-auto" style="max-height: 200px;">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Condition</th>
                                        <th>Temp</th>
                                        <th>Precip</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>09:00</td>
                                        <td><i class="fas fa-cloud-sun"></i> Partly Cloudy</td>
                                        <td>26°C</td>
                                        <td>0%</td>
                                    </tr>
                                    <tr>
                                        <td>10:00</td>
                                        <td><i class="fas fa-cloud-sun"></i> Partly Cloudy</td>
                                        <td>27°C</td>
                                        <td>0%</td>
                                    </tr>
                                    <tr>
                                        <td>11:00</td>
                                        <td><i class="fas fa-cloud"></i> Cloudy</td>
                                        <td>28°C</td>
                                        <td>10%</td>
                                    </tr>
                                    <tr>
                                        <td>12:00</td>
                                        <td><i class="fas fa-cloud-rain"></i> Light Rain</td>
                                        <td>27°C</td>
                                        <td>40%</td>
                                    </tr>
                                    <!-- More hourly forecasts -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Climate Data Tab -->
                <div class="tab-pane fade" id="climate-data" role="tabpanel" aria-labelledby="climate-tab">
                    <div class="mb-3">
                        <label for="climate-region" class="form-label">Region:</label>
                        <select id="climate-region" class="form-select">
                            <option value="qld">Queensland</option>
                            <option value="nsw">New South Wales</option>
                            <option value="vic">Victoria</option>
                            <option value="wa">Western Australia</option>
                            <option value="sa">South Australia</option>
                            <option value="tas">Tasmania</option>
                            <option value="nt">Northern Territory</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="climate-year" class="form-label">Reference Year:</label>
                        <select id="climate-year" class="form-select">
                            <option value="2025">2025 (Current)</option>
                            <option value="2030">2030 Projection</option>
                            <option value="2050">2050 Projection</option>
                        </select>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header">Rainfall Patterns</div>
                        <div class="card-body p-2">
                            <canvas id="rainfall-climate-chart" height="150"></canvas>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header">Flood Frequency</div>
                        <div class="card-body p-2">
                            <canvas id="flood-climate-chart" height="150"></canvas>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6>Climate Summary</h6>
                        <p class="small mb-0">
                            Queensland is projected to experience a 30% increase in extreme rainfall events by 2050,
                            with more frequent flash flooding in urban areas and extended riverine flooding periods.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scenario Comparison Panel -->
    <div class="panel filter-panel" id="compare-panel" style="display: none; top: 140px; left: 160px; width: 600px;">
        <div class="filter-header">
            <h4><i class="fas fa-code-compare me-2"></i>Compare Scenarios</h4>
            <button class="layer-info-btn" id="compare-close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="filter-content">
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Scenario A</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Region</label>
                                <select id="scenario-a-region" class="form-select">
                                    <option value="qld">Queensland</option>
                                    <option value="nsw">New South Wales</option>
                                    <option value="vic">Victoria</option>
                                    <option value="wa">Western Australia</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Time Period</label>
                                <select id="scenario-a-time" class="form-select">
                                    <option value="current">Current (2025)</option>
                                    <option value="2030">2030 Projection</option>
                                    <option value="2050">2050 Projection</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Climate Scenario</label>
                                <select id="scenario-a-climate" class="form-select">
                                    <option value="moderate">Moderate Change</option>
                                    <option value="extreme">Extreme Change</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Scenario B</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Region</label>
                                <select id="scenario-b-region" class="form-select">
                                    <option value="qld">Queensland</option>
                                    <option value="nsw" selected>New South Wales</option>
                                    <option value="vic">Victoria</option>
                                    <option value="wa">Western Australia</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Time Period</label>
                                <select id="scenario-b-time" class="form-select">
                                    <option value="current">Current (2025)</option>
                                    <option value="2030" selected>2030 Projection</option>
                                    <option value="2050">2050 Projection</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Climate Scenario</label>
                                <select id="scenario-b-climate" class="form-select">
                                    <option value="moderate">Moderate Change</option>
                                    <option value="extreme" selected>Extreme Change</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mb-3">
                <button id="run-comparison" class="btn btn-primary">
                    <i class="fas fa-play me-2"></i>Run Comparison
                </button>
            </div>
            
            <div id="comparison-results" style="display: none;">
                <h5>Comparison Results</h5>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">Flood Risk</div>
                            <div class="card-body p-2">
                                <canvas id="comparison-flood-risk" height="180"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">Economic Impact</div>
                            <div class="card-body p-2">
                                <canvas id="comparison-economic" height="180"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <h6>Key Findings</h6>
                    <ul class="mb-0 small">
                        <li>Scenario B shows a 45% higher flood risk than Scenario A</li>
                        <li>Economic impacts in Scenario B are estimated to be 3.2x higher</li>
                        <li>Infrastructure vulnerability increases dramatically under extreme climate conditions</li>
                    </ul>
                </div>
                
                <div class="d-flex justify-content-between">
                    <button id="save-comparison" class="btn btn-success">
                        <i class="fas fa-save me-2"></i>Save Comparison
                    </button>
                    <button id="generate-comparison-report" class="btn btn-primary">
                        <i class="fas fa-file-alt me-2"></i>Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/leaflet-geometryutil@0.10.1/src/leaflet.geometryutil.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="flood_functions.js"></script>
    
    <script>
        // Global variables
        window.map = null;
        window.miniMap = null;
        window.reportOverlay = null;
        window.pulseMarker = null;
        window.lastReportSettings = null;
        window.applyToMainMap = false;
        window.heatmapLayer = null;
        window.measureControl = null;
        
        // Initialize UI, map and charts on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize maps first
            initMap();
            
            // Then initialize UI since it depends on the map
            initUI();
            
            // Initialize charts
            initCharts();
            
            // Load flood warnings
            loadFloodWarnings();
            
            // Initialize chatbot
            initChatbot();
            
            // Make panels draggable
            makePanelsDraggable();
            
            // Setup ESG panel interactive components
            setTimeout(() => {
                initMiniMap();
                setupInteractiveFilters();
            }, 1000);
            
            // Set up weather panel toggle
            document.getElementById('weather-btn').addEventListener('click', function() {
                this.classList.toggle('active');
                let weatherPanel = document.getElementById('weather-panel');
                
                // Create the panel if it doesn't exist
                if (!weatherPanel) {
                    weatherPanel = document.createElement('div');
                    weatherPanel.id = 'weather-panel';
                    weatherPanel.className = 'panel filter-panel';
                    weatherPanel.style.display = 'none';
                    weatherPanel.style.top = '120px';
                    weatherPanel.style.left = '140px';
                    weatherPanel.style.width = '400px';
                    
                    weatherPanel.innerHTML = `
                        <div class="filter-header">
                            <h4><i class="fas fa-cloud-sun-rain me-2"></i>Weather & Climate</h4>
                            <button class="layer-info-btn" id="weather-close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="filter-content">
                            <ul class="nav nav-tabs mb-3" id="weather-tabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="current-tab" data-bs-toggle="tab" data-bs-target="#current-weather" type="button" role="tab">Current</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="forecast-tab" data-bs-toggle="tab" data-bs-target="#forecast-weather" type="button" role="tab">Forecast</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="historical-tab" data-bs-toggle="tab" data-bs-target="#historical-weather" type="button" role="tab">Historical</button>
                                </li>
                            </ul>
                            
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="current-weather" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card mb-3">
                                                <div class="card-body">
                                                    <h6 class="card-title">Current Rainfall</h6>
                                                    <canvas id="current-rainfall-chart" height="200"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card mb-3">
                                                <div class="card-body">
                                                    <h6 class="card-title">Flood Risk</h6>
                                                    <canvas id="current-risk-gauge" height="200"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title">Recent Weather Events</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Event</th>
                                                            <th>Location</th>
                                                            <th>Date</th>
                                                            <th>Severity</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="weather-events-tbody">
                                                        <!-- Will be populated by JS -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="forecast-weather" role="tabpanel">
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title">7-Day Precipitation Forecast</h6>
                                            <canvas id="forecast-chart" height="200"></canvas>
                                        </div>
                                    </div>
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title">Flood Warning Forecast</h6>
                                            <div id="forecast-map" style="height: 250px;"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="historical-weather" role="tabpanel">
                                    <div class="form-group mb-3">
                                        <label>Select Time Period:</label>
                                        <select class="form-select" id="historical-period">
                                            <option value="12month">Last 12 Months</option>
                                            <option value="36month">Last 36 Months</option>
                                            <option value="5year">Last 5 Years</option>
                                        </select>
                                    </div>
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title">Historical Rainfall Patterns</h6>
                                            <canvas id="historical-chart" height="200"></canvas>
                                        </div>
                                    </div>
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title">Anomaly Analysis</h6>
                                            <canvas id="anomaly-chart" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(weatherPanel);
                    
                    // Add event listener for the close button
                    document.getElementById('weather-close').addEventListener('click', function() {
                        document.getElementById('weather-btn').classList.remove('active');
                        weatherPanel.style.display = 'none';
                    });
                    
                    // Make the panel draggable
                    makeDraggable(weatherPanel);
                }
                
                weatherPanel.style.display = weatherPanel.style.display === 'none' || weatherPanel.style.display === '' ? 'block' : 'none';
                
                // Initialize weather charts when panel is opened
                if (weatherPanel.style.display === 'block') {
                    initWeatherCharts();
                }
            });
            
            // Note: Close button event listener is now added when the panel is created
            
            // Set up comparison panel toggle
            document.getElementById('compare-btn').addEventListener('click', function() {
                this.classList.toggle('active');
                let comparePanel = document.getElementById('compare-panel');
                
                // Create the panel if it doesn't exist
                if (!comparePanel) {
                    comparePanel = document.createElement('div');
                    comparePanel.id = 'compare-panel';
                    comparePanel.className = 'panel filter-panel';
                    comparePanel.style.display = 'none';
                    comparePanel.style.top = '140px';
                    comparePanel.style.left = '160px';
                    comparePanel.style.width = '600px';
                    
                    comparePanel.innerHTML = `
                        <div class="filter-header">
                            <h4><i class="fas fa-code-compare me-2"></i>Compare Scenarios</h4>
                            <button class="layer-info-btn" id="compare-close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="filter-content">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="m-0">Scenario A</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group mb-2">
                                                <label>Region:</label>
                                                <select class="form-select form-select-sm" id="scenario-a-region">
                                                    <option value="queensland">Queensland</option>
                                                    <option value="nsw">New South Wales</option>
                                                    <option value="victoria">Victoria</option>
                                                    <option value="nt">Northern Territory</option>
                                                    <option value="wa">Western Australia</option>
                                                </select>
                                            </div>
                                            <div class="form-group mb-2">
                                                <label>Risk Level:</label>
                                                <select class="form-select form-select-sm" id="scenario-a-risk">
                                                    <option value="low">Low</option>
                                                    <option value="medium">Medium</option>
                                                    <option value="high">High</option>
                                                </select>
                                            </div>
                                            <div class="form-group mb-2">
                                                <label>Climate Scenario:</label>
                                                <select class="form-select form-select-sm" id="scenario-a-climate">
                                                    <option value="current">Current</option>
                                                    <option value="rcp45">RCP 4.5</option>
                                                    <option value="rcp85">RCP 8.5</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="m-0">Scenario B</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-group mb-2">
                                                <label>Region:</label>
                                                <select class="form-select form-select-sm" id="scenario-b-region">
                                                    <option value="queensland">Queensland</option>
                                                    <option value="nsw">New South Wales</option>
                                                    <option value="victoria">Victoria</option>
                                                    <option value="nt">Northern Territory</option>
                                                    <option value="wa">Western Australia</option>
                                                </select>
                                            </div>
                                            <div class="form-group mb-2">
                                                <label>Risk Level:</label>
                                                <select class="form-select form-select-sm" id="scenario-b-risk">
                                                    <option value="low">Low</option>
                                                    <option value="medium">Medium</option>
                                                    <option value="high">High</option>
                                                </select>
                                            </div>
                                            <div class="form-group mb-2">
                                                <label>Climate Scenario:</label>
                                                <select class="form-select form-select-sm" id="scenario-b-climate">
                                                    <option value="current">Current</option>
                                                    <option value="rcp45">RCP 4.5</option>
                                                    <option value="rcp85">RCP 8.5</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary mb-3 w-100" id="run-comparison">Run Comparison Analysis</button>
                            
                            <div class="comparison-results" style="display: none;">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">Risk Comparison</h6>
                                        <canvas id="risk-comparison-chart" height="200"></canvas>
                                    </div>
                                </div>
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">Financial Impact</h6>
                                        <canvas id="financial-comparison-chart" height="200"></canvas>
                                    </div>
                                </div>
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6 class="card-title">ESG Impact Comparison</h6>
                                        <canvas id="esg-comparison-chart" height="200"></canvas>
                                    </div>
                                </div>
                                <div class="text-center">
                                    <button class="btn btn-success" id="export-comparison">Export Comparison Report</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(comparePanel);
                    
                    // Add event listener for the close button
                    document.getElementById('compare-close').addEventListener('click', function() {
                        document.getElementById('compare-btn').classList.remove('active');
                        comparePanel.style.display = 'none';
                    });
                    
                    // Make the panel draggable
                    makeDraggable(comparePanel);
                }
                
                comparePanel.style.display = comparePanel.style.display === 'none' || comparePanel.style.display === '' ? 'block' : 'none';
                
                // Initialize comparison charts when panel is opened
                if (comparePanel.style.display === 'block') {
                    initComparisonCharts();
                }
            });
            
            // Note: Close button event listener is now added when the panel is created
            
            // Add process-files event listener
            const processFilesBtn = document.getElementById('process-files');
            if (processFilesBtn) {
                processFilesBtn.addEventListener('click', processFilesWithOptions);
            } else {
                console.warn("Process files button not found");
            }
            
            // Add time slider event listeners
            const timeSlider = document.getElementById('time-slider');
            if (timeSlider) {
                timeSlider.addEventListener('input', updateTimeSliderDisplay);
            }
            
            // Add play button listener
            const playBtn = document.getElementById('play-time-slider');
            if (playBtn) {
                playBtn.addEventListener('click', playTimeSlider);
            }
        });
        
        // Make all panels draggable
        function makePanelsDraggable() {
            const panels = [
                document.getElementById('layer-panel'),
                document.getElementById('filter-panel'),
                document.getElementById('time-slider-container'),
                document.getElementById('data-panel'),
                document.getElementById('weather-panel'),
                document.getElementById('compare-panel')
            ];
            
            panels.forEach(panel => {
                if (panel) {
                    makeDraggable(panel);
                }
            });
            
            // Function to make an element draggable
            function makeDraggable(element) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                
                // Get the header as the drag handle
                const header = element.querySelector('.layer-header, .filter-header, .time-slider-header');
                
                if (header) {
                    header.onmousedown = dragMouseDown;
                } else {
                    // If no header, use the element itself
                    element.onmousedown = dragMouseDown;
                }
                
                function dragMouseDown(e) {
                    e.preventDefault();
                    // Get the mouse cursor position at startup:
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    // Call a function whenever the cursor moves:
                    document.onmousemove = elementDrag;
                }
                
                function elementDrag(e) {
                    e.preventDefault();
                    // Calculate the new cursor position:
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    // Set the element's new position:
                    element.style.top = (element.offsetTop - pos2) + "px";
                    element.style.left = (element.offsetLeft - pos1) + "px";
                    
                    // Remove transform if it exists (for centered elements)
                    if (element.style.transform) {
                        element.style.transform = "none";
                    }
                }
                
                function closeDragElement() {
                    // Stop moving when mouse button is released:
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
            }
        }
        
        // Initialize the main UI components and event listeners
        function initUI() {
            // Set up button click handlers
            document.getElementById('esg-btn').addEventListener('click', function() {
                this.classList.toggle('active');
                const esgPanel = document.getElementById('esg-panel');
                esgPanel.classList.toggle('active');
                
                // Toggle body scrolling
                if (esgPanel.classList.contains('active')) {
                    document.body.style.overflow = 'hidden';
                } else {
                    document.body.style.overflow = 'auto';
                    
                    // Check if we should apply report settings to the main map when closing via toggle
                    if (window.applyToMainMap && window.lastReportSettings) {
                        const settings = window.lastReportSettings;
                        
                        // Update main map with stored settings
                        updateMainMap(settings.region, settings.riskLevel, settings.scenario, settings.visType, true);
                        
                        // Add engineering report overlay to the MAIN map
                        addEngineeringReportOverlay(settings.region, settings.riskLevel, settings.scenario);
                        
                        // Reset the flag
                        window.applyToMainMap = false;
                        
                        // Show toast notification
                        showToast('Engineering Report applied to main map');
                    }
                }
            });
            
            document.getElementById('esg-close').addEventListener('click', function() {
                document.getElementById('esg-panel').classList.remove('active');
                document.getElementById('esg-btn').classList.remove('active');
                document.body.style.overflow = 'auto';
                
                // Check if we should apply report settings to the main map
                if (window.applyToMainMap && window.lastReportSettings) {
                    const settings = window.lastReportSettings;
                    
                    // Update main map with stored settings
                    updateMainMap(settings.region, settings.riskLevel, settings.scenario, settings.visType, true);
                    
                    // Add engineering report overlay to the MAIN map
                    addEngineeringReportOverlay(settings.region, settings.riskLevel, settings.scenario);
                    
                    // Reset the flag
                    window.applyToMainMap = false;
                    
                    // Show toast notification
                    showToast('Engineering Report applied to main map');
                }
            });
            
            document.getElementById('layer-btn').addEventListener('click', function() {
                this.classList.toggle('active');
                const layerPanel = document.getElementById('layer-panel');
                if (layerPanel.style.display === 'none' || layerPanel.style.display === '') {
                    layerPanel.style.display = 'block';
                    
                    // Ensure it's visible for a minimum time
                    layerPanel.dataset.openTime = Date.now();
                } else {
                    // Only close if it's been open for at least 500ms
                    const openTime = parseInt(layerPanel.dataset.openTime || 0);
                    if (Date.now() - openTime > 500) {
                        layerPanel.style.display = 'none';
                    }
                }
            });
            
            document.getElementById('layer-close').addEventListener('click', function() {
                document.getElementById('layer-panel').style.display = 'none';
                document.getElementById('layer-btn').classList.remove('active');
            });
            
            document.getElementById('filter-btn').addEventListener('click', function() {
                this.classList.toggle('active');
                const filterPanel = document.getElementById('filter-panel');
                if (filterPanel.style.display === 'none' || filterPanel.style.display === '') {
                    filterPanel.style.display = 'block';
                    
                    // Ensure it's visible for a minimum time
                    filterPanel.dataset.openTime = Date.now();
                } else {
                    // Only close if it's been open for at least 500ms
                    const openTime = parseInt(filterPanel.dataset.openTime || 0);
                    if (Date.now() - openTime > 500) {
                        filterPanel.style.display = 'none';
                    }
                }
            });
            
            document.getElementById('filter-close').addEventListener('click', function() {
                document.getElementById('filter-panel').style.display = 'none';
                document.getElementById('filter-btn').classList.remove('active');
            });
            
            document.getElementById('time-btn').addEventListener('click', function() {
                this.classList.toggle('active');
                const timeSlider = document.getElementById('time-slider-container');
                timeSlider.style.display = timeSlider.style.display === 'none' || timeSlider.style.display === '' ? 'block' : 'none';
            });
            
            document.getElementById('time-slider-close').addEventListener('click', function() {
                document.getElementById('time-slider-container').style.display = 'none';
                document.getElementById('time-btn').classList.remove('active');
            });
            
            // Add time slider functionality
            document.getElementById('time-slider').addEventListener('input', function() {
                updateTimeDisplay();
            });
            
            // Time slider animation
            let timeInterval;
            let isPlaying = false;
            
            function updateTimeDisplay() {
                const value = document.getElementById('time-slider').value;
                let date;
                
                // Map slider value to date
                if (value <= 25) {
                    // January
                    const day = Math.ceil(value / 25 * 31);
                    date = `January ${day}, 2025`;
                } else if (value <= 50) {
                    // February
                    const day = Math.ceil((value - 25) / 25 * 28);
                    date = `February ${day}, 2025`;
                } else if (value <= 75) {
                    // March
                    const day = Math.ceil((value - 50) / 25 * 31);
                    date = `March ${day}, 2025`;
                } else {
                    // April
                    const day = Math.ceil((value - 75) / 25 * 30);
                    date = `April ${day}, 2025`;
                }
                
                // Update the date display
                document.getElementById('current-date').textContent = date;
            }
            
            // Play/Pause time slider
            document.getElementById('play-time-btn').addEventListener('click', function() {
                if (isPlaying) {
                    // Stop playing
                    clearInterval(timeInterval);
                    this.innerHTML = '<i class="fas fa-play"></i>';
                    isPlaying = false;
                } else {
                    // Start playing
                    this.innerHTML = '<i class="fas fa-pause"></i>';
                    isPlaying = true;
                    
                    timeInterval = setInterval(() => {
                        const slider = document.getElementById('time-slider');
                        let value = parseInt(slider.value);
                        
                        if (value < 100) {
                            value += 1;
                            slider.value = value;
                            updateTimeDisplay();
                        } else {
                            // Reached the end, stop playing
                            clearInterval(timeInterval);
                            document.getElementById('play-time-btn').innerHTML = '<i class="fas fa-play"></i>';
                            isPlaying = false;
                        }
                    }, 200);
                }
            });
            
            // Data files button
            document.getElementById('data-btn').addEventListener('click', function() {
                this.classList.toggle('active');
                const dataPanel = document.getElementById('data-panel');
                dataPanel.style.display = dataPanel.style.display === 'none' || dataPanel.style.display === '' ? 'block' : 'none';
            });
            
            document.getElementById('data-close').addEventListener('click', function() {
                document.getElementById('data-panel').style.display = 'none';
                document.getElementById('data-btn').classList.remove('active');
            });
            
            // Process uploaded files
            document.getElementById('process-files').addEventListener('click', function() {
                const rainfallFile = document.getElementById('rainfall-data').files[0];
                const historicalFile = document.getElementById('historical-data').files[0];
                const floodWarningsFile = document.getElementById('flood-warnings').files[0];
                const floodPolygonsFile = document.getElementById('flood-polygons').files[0];
                
                // Show loading spinner
                const processBtn = document.getElementById('process-files');
                const originalText = processBtn.innerHTML;
                processBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';
                processBtn.disabled = true;
                
                let filesProcessed = 0;
                let totalFiles = 0;
                
                if (rainfallFile) {
                    totalFiles++;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            // Parse CSV data
                            Papa.parse(e.target.result, {
                                header: true,
                                complete: function(results) {
                                    // Store rainfall data
                                    window.rainfallData = results.data;
                                    filesProcessed++;
                                    checkComplete();
                                }
                            });
                        } catch (err) {
                            console.error('Error parsing rainfall data:', err);
                            showToast('Error parsing rainfall data');
                        }
                    };
                    reader.readAsText(rainfallFile);
                }
                
                if (historicalFile) {
                    totalFiles++;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            // Parse CSV data
                            Papa.parse(e.target.result, {
                                header: true,
                                complete: function(results) {
                                    // Store historical data
                                    window.historicalData = results.data;
                                    filesProcessed++;
                                    checkComplete();
                                }
                            });
                        } catch (err) {
                            console.error('Error parsing historical data:', err);
                            showToast('Error parsing historical data');
                        }
                    };
                    reader.readAsText(historicalFile);
                }
                
                if (floodWarningsFile) {
                    totalFiles++;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            // Parse JSON data
                            const data = JSON.parse(e.target.result);
                            // Store flood warnings data
                            window.floodWarningsData = data;
                            filesProcessed++;
                            checkComplete();
                        } catch (err) {
                            console.error('Error parsing flood warnings data:', err);
                            showToast('Error parsing flood warnings data');
                        }
                    };
                    reader.readAsText(floodWarningsFile);
                }
                
                if (floodPolygonsFile) {
                    totalFiles++;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            // Parse JSON data
                            const data = JSON.parse(e.target.result);
                            // Store flood polygons data
                            window.floodPolygonsData = data;
                            filesProcessed++;
                            checkComplete();
                        } catch (err) {
                            console.error('Error parsing flood polygons data:', err);
                            showToast('Error parsing flood polygons data');
                        }
                    };
                    reader.readAsText(floodPolygonsFile);
                }
                
                function checkComplete() {
                    if (filesProcessed === totalFiles && totalFiles > 0) {
                        // Restore button
                        setTimeout(() => {
                            processBtn.innerHTML = originalText;
                            processBtn.disabled = false;
                        }, 500);
                        
                        showToast(`Successfully processed ${totalFiles} file(s)`);
                        
                        // Process flood data if available
                        if (window.floodWarningsData && window.floodPolygonsData) {
                            // Remove existing flood layers
                            if (window.floodWarningLayer) {
                                window.map.removeLayer(window.floodWarningLayer);
                            }
                            if (window.floodPolygonLayer) {
                                window.map.removeLayer(window.floodPolygonLayer);
                            }
                            
                            // Create new flood layers
                            const floodWarningLayer = L.layerGroup();
                            const floodPolygonLayer = L.layerGroup();
                            
                            // Process flood warnings
                            window.floodWarningsData.forEach(warning => {
                                let centerLat, centerLng;
                                
                                if (warning.state === 'Queensland') {
                                    centerLat = -23.5 + (Math.random() * 2 - 1);
                                    centerLng = 144.0 + (Math.random() * 2 - 1);
                                } else if (warning.state === 'New South Wales') {
                                    centerLat = -32.0 + (Math.random() * 2 - 1);
                                    centerLng = 147.0 + (Math.random() * 2 - 1);
                                } else {
                                    centerLat = -25.0 + (Math.random() * 2 - 1);
                                    centerLng = 134.0 + (Math.random() * 2 - 1);
                                }
                                
                                // Create a circular area based on polygons_count
                                const radius = warning.polygons_count ? Math.max(warning.polygons_count * 5000, 20000) : 50000;
                                
                                const circle = L.circle([centerLat, centerLng], {
                                    radius: radius,
                                    color: 'red',
                                    fillColor: '#f03',
                                    fillOpacity: 0.3
                                });
                                
                                // Also add a marker at the center
                                const marker = L.circleMarker([centerLat, centerLng], {
                                    radius: 8,
                                    fillColor: '#ffc107',
                                    color: '#000',
                                    weight: 1,
                                    opacity: 1,
                                    fillOpacity: 0.8
                                });
                                
                                const popupContent = `
                                    <div style="max-width: 300px;">
                                        <h5>${warning.headline || 'Flood Warning'}</h5>
                                        <p><strong>Location:</strong> ${warning.state || 'Unknown'}</p>
                                        <p><strong>Severity:</strong> ${warning.severity || 'Unknown'}</p>
                                        <p><strong>Start:</strong> ${warning.start || 'Unknown'}</p>
                                        <p><strong>End:</strong> ${warning.end || 'Unknown'}</p>
                                        <p>${warning.description || ''}</p>
                                        <p class="text-danger"><strong>Instruction:</strong> ${warning.instruction || 'Follow local emergency instructions'}</p>
                                    </div>
                                `;
                                
                                // Bind popup to both circle and marker
                                circle.bindPopup(popupContent);
                                marker.bindPopup(popupContent);
                                
                                // Add both to layer
                                floodWarningLayer.addLayer(circle);
                                floodWarningLayer.addLayer(marker);
                            });
                            
                            // Process flood polygons
                            if (window.floodPolygonsData.features) {
                                const geoJsonLayer = L.geoJSON(window.floodPolygonsData, {
                                    style: function(feature) {
                                        return {
                                            fillColor: '#dc3545',
                                            weight: 2,
                                            opacity: 1,
                                            color: '#9c2a33',
                                            fillOpacity: 0.6
                                        };
                                    },
                                    onEachFeature: function(feature, layer) {
                                        if (feature.properties) {
                                            const popupContent = `
                                                <div style="max-width: 300px;">
                                                    <h5>${feature.properties.headline || 'Flood Area'}</h5>
                                                    <p><strong>Location:</strong> ${feature.properties.name || 'Unknown'}</p>
                                                    <p><strong>Severity:</strong> ${feature.properties.severity || 'Unknown'}</p>
                                                    <p>${feature.properties.description || ''}</p>
                                                </div>
                                            `;
                                            
                                            layer.bindPopup(popupContent);
                                        }
                                    }
                                });
                                
                                floodPolygonLayer.addLayer(geoJsonLayer);
                            }
                            
                            // Store the layers
                            window.floodWarningLayer = floodWarningLayer;
                            window.floodPolygonLayer = floodPolygonLayer;
                            
                            // Add to map if toggles are checked
                            if (document.getElementById('flood-warnings-visibility').checked) {
                                window.map.addLayer(floodWarningLayer);
                            }
                            
                            if (document.getElementById('flood-polygons-visibility').checked) {
                                window.map.addLayer(floodPolygonLayer);
                            }
                            
                            showToast('Flood data loaded and applied to map');
                        }
                        
                        // Process rainfall data if available
                        if (window.rainfallData && window.rainfallData.length > 0) {
                            // Clear existing rainfall layers
                            if (window.map.hasLayer(window.layers.dailyRainfall)) {
                                window.map.removeLayer(window.layers.dailyRainfall);
                            }
                            if (window.map.hasLayer(window.layers.twelveMonthRainfall)) {
                                window.map.removeLayer(window.layers.twelveMonthRainfall);
                            }
                            if (window.map.hasLayer(window.layers.thirtySixMonthRainfall)) {
                                window.map.removeLayer(window.layers.thirtySixMonthRainfall);
                            }
                            
                            // Reset layers
                            window.layers.dailyRainfall = L.layerGroup();
                            window.layers.twelveMonthRainfall = L.layerGroup();
                            window.layers.thirtySixMonthRainfall = L.layerGroup();
                            
                            // Process rainfall data
                            window.rainfallData.forEach(station => {
                                // Try to extract coordinates
                                let lat = null, lng = null;
                                
                                // Try to find lat/long in various formats
                                const latFields = ['Latitude (°)', 'Latitude (Â°)', 'Latitude', 'Latitude (deg)'];
                                const lonFields = ['Longitude (°)', 'Longitude (Â°)', 'Longitude', 'Longitude (deg)'];
                                
                                for (const field of latFields) {
                                    if (station[field] !== undefined && station[field] !== null) {
                                        lat = parseFloat(station[field]);
                                        break;
                                    }
                                }
                                
                                for (const field of lonFields) {
                                    if (station[field] !== undefined && station[field] !== null) {
                                        lng = parseFloat(station[field]);
                                        break;
                                    }
                                }
                                
                                // If we don't have proper coordinates, skip this station
                                if (isNaN(lat) || isNaN(lng)) return;
                                
                                // Check if we have a 12-month rainfall value
                                if (station['12-month rainfall'] || station['12 month rainfall']) {
                                    const rainfallValue = parseFloat(station['12-month rainfall'] || station['12 month rainfall'] || 0);
                                    
                                    if (!isNaN(rainfallValue)) {
                                        // Create marker with size and color based on rainfall value
                                        const marker = L.circleMarker([lat, lng], {
                                            radius: Math.min(rainfallValue / 20, 15),
                                            color: '#3388ff',
                                            fillColor: '#3388ff',
                                            fillOpacity: 0.7,
                                            weight: 1
                                        });
                                        
                                        // Create popup with station details
                                        const popupContent = `
                                            <div style="max-width: 300px;">
                                                <h5>${station['Station name'] || 'Weather Station'}</h5>
                                                <p><strong>12-Month Rainfall:</strong> ${rainfallValue.toFixed(1)} mm</p>
                                                <p><strong>Latitude:</strong> ${lat.toFixed(4)}</p>
                                                <p><strong>Longitude:</strong> ${lng.toFixed(4)}</p>
                                            </div>
                                        `;
                                        
                                        marker.bindPopup(popupContent);
                                        
                                        // Add to 12-month rainfall layer
                                        window.layers.twelveMonthRainfall.addLayer(marker);
                                    }
                                }
                            });
                            
                            // Add layer to map if toggle is checked
                            if (document.getElementById('12month-rainfall-visibility').checked) {
                                window.map.addLayer(window.layers.twelveMonthRainfall);
                            }
                            
                            showToast('Rainfall data loaded and ready to display');
                        }
                        
                        // Process historical events if available
                        if (window.historicalData && window.historicalData.length > 0) {
                            // Clear existing events layer
                            if (window.map.hasLayer(window.layers.events)) {
                                window.map.removeLayer(window.layers.events);
                            }
                            
                            // Reset events layer
                            window.layers.events = L.layerGroup();
                            
                            // Process historical events
                            window.historicalData.forEach(event => {
                                // Extract coordinates
                                const lat = parseFloat(event.Latitude);
                                const lng = parseFloat(event.Longitude);
                                
                                if (!isNaN(lat) && !isNaN(lng)) {
                                    // Determine marker icon based on event type
                                    let iconColor, eventType;
                                    
                                    if (event.Type && event.Type.toLowerCase().includes('flood')) {
                                        iconColor = '#3388ff'; // Blue for floods
                                        eventType = 'Flood';
                                    } else if (event.Type && event.Type.toLowerCase().includes('cyclone')) {
                                        iconColor = '#9933cc'; // Purple for cyclones
                                        eventType = 'Cyclone';
                                    } else if (event.Type && event.Type.toLowerCase().includes('fire')) {
                                        iconColor = '#ff3333'; // Red for fires
                                        eventType = 'Fire';
                                    } else {
                                        iconColor = '#ff9900'; // Orange for other events
                                        eventType = event.Type || 'Weather Event';
                                    }
                                    
                                    // Create marker
                                    const marker = L.circleMarker([lat, lng], {
                                        radius: 6,
                                        color: '#000',
                                        fillColor: iconColor,
                                        fillOpacity: 0.8,
                                        weight: 1
                                    });
                                    
                                    // Create popup with event details
                                    const date = event['Date/Time'] || event.Date || 'Unknown date';
                                    const location = event.Location || event.State || 'Unknown location';
                                    const description = event.Description || event.Details || '';
                                    
                                    const popupContent = `
                                        <div style="max-width: 300px;">
                                            <h5>${eventType}</h5>
                                            <p><strong>Date:</strong> ${date}</p>
                                            <p><strong>Location:</strong> ${location}</p>
                                            <p>${description}</p>
                                        </div>
                                    `;
                                    
                                    marker.bindPopup(popupContent);
                                    
                                    // Add to events layer
                                    window.layers.events.addLayer(marker);
                                }
                            });
                            
                            // Add layer to map if toggle is checked
                            if (document.getElementById('events-visibility').checked) {
                                window.map.addLayer(window.layers.events);
                            }
                            
                            showToast('Historical events loaded and ready to display');
                        }
                    }
                }
            });
            
            document.getElementById('fullscreen-btn').addEventListener('click', function() {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                    this.innerHTML = '<i class="fas fa-expand"></i>';
                } else {
                    document.documentElement.requestFullscreen();
                    this.innerHTML = '<i class="fas fa-compress"></i>';
                }
            });
            
            // Initialize "Generate Engineering Report" button
            document.getElementById('generate-report').addEventListener('click', function() {
                const region = document.getElementById('analysis-region').value;
                const riskLevel = document.getElementById('risk-level').value;
                const scenario = document.getElementById('time-scenario').value;
                const visType = document.getElementById('visualization-type').value;
                
                // Update the mini map with selected parameters
                updateMiniMap(region, riskLevel, scenario, visType);
                
                // Update region stats
                updateRegionStats(region, riskLevel, scenario);
                
                // Store the selections for later use when closing the panel
                window.lastReportSettings = {
                    region: region,
                    riskLevel: riskLevel,
                    scenario: scenario,
                    visType: visType
                };
                
                // Check if we should apply to main map when closing the panel
                window.applyToMainMap = document.getElementById('apply-to-main').checked;
                
                // Show a toast notification
                showToast('Engineering Report generated for ' + getRegionName(region));
            });
            
            // Initialize layer visibility checkboxes
            document.getElementById('events-visibility').addEventListener('change', function() {
                if (this.checked) {
                    window.map.addLayer(window.layers.events);
                } else {
                    window.map.removeLayer(window.layers.events);
                }
            });
            
            document.getElementById('daily-rainfall-visibility').addEventListener('change', function() {
                if (this.checked) {
                    window.map.addLayer(window.layers.dailyRainfall);
                } else {
                    window.map.removeLayer(window.layers.dailyRainfall);
                }
            });
            
            document.getElementById('12month-rainfall-visibility').addEventListener('change', function() {
                if (this.checked) {
                    window.map.addLayer(window.layers.twelveMonthRainfall);
                } else {
                    window.map.removeLayer(window.layers.twelveMonthRainfall);
                }
            });
            
            document.getElementById('36month-rainfall-visibility').addEventListener('change', function() {
                if (this.checked) {
                    window.map.addLayer(window.layers.thirtySixMonthRainfall);
                } else {
                    window.map.removeLayer(window.layers.thirtySixMonthRainfall);
                }
            });
            
            document.getElementById('custom-locations-visibility').addEventListener('change', function() {
                if (this.checked) {
                    window.map.addLayer(window.layers.customLocations);
                } else {
                    window.map.removeLayer(window.layers.customLocations);
                }
            });
            
            document.getElementById('flood-warnings-visibility').addEventListener('change', updateFloodLayerVisibility);
            document.getElementById('flood-polygons-visibility').addEventListener('change', updateFloodLayerVisibility);
            
            // Set up heatmap and risk assessment layer visibility
            document.getElementById('heatmap-visibility').addEventListener('change', function() {
                if (this.checked) {
                    updateHeatmap();
                    window.map.addLayer(window.heatmapLayer);
                } else {
                    window.map.removeLayer(window.heatmapLayer);
                }
            });
            
            document.getElementById('risk-visibility').addEventListener('change', function() {
                if (this.checked) {
                    generateRiskLayer();
                    window.map.addLayer(window.layers.riskAssessment);
                } else {
                    window.map.removeLayer(window.layers.riskAssessment);
                }
            });
            
            // Set up export panel toggle
            document.getElementById('export-btn').addEventListener('click', function() {
                this.classList.toggle('active');
                document.getElementById('export-panel').style.display = document.getElementById('export-panel').style.display === 'none' || document.getElementById('export-panel').style.display === '' ? 'block' : 'none';
            });
            
            // Set up export panel close button
            document.getElementById('export-close').addEventListener('click', function() {
                document.getElementById('export-panel').style.display = 'none';
                document.getElementById('export-btn').classList.remove('active');
            });
            
            // Set up measurement panel toggle
            document.getElementById('measurement-btn').addEventListener('click', function() {
                this.classList.toggle('active');
                document.getElementById('measurement-panel').style.display = document.getElementById('measurement-panel').style.display === 'none' || document.getElementById('measurement-panel').style.display === '' ? 'block' : 'none';
            });
            
            // Set up measurement panel close button
            document.getElementById('measurement-close').addEventListener('click', function() {
                document.getElementById('measurement-panel').style.display = 'none';
                document.getElementById('measurement-btn').classList.remove('active');
            });
            
            // Set up weather panel toggle
            document.getElementById('weather-btn').addEventListener('click', function() {
                this.classList.toggle('active');
                document.getElementById('weather-panel').style.display = document.getElementById('weather-panel').style.display === 'none' || document.getElementById('weather-panel').style.display === '' ? 'block' : 'none';
                
                // Initialize weather charts when panel is opened
                if (document.getElementById('weather-panel').style.display === 'block') {
                    initWeatherCharts();
                }
            });
            
            // Set up weather panel close button
            document.getElementById('weather-close').addEventListener('click', function() {
                document.getElementById('weather-panel').style.display = 'none';
                document.getElementById('weather-btn').classList.remove('active');
            });
            
            // Set up comparison panel toggle
            document.getElementById('compare-btn').addEventListener('click', function() {
                this.classList.toggle('active');
                document.getElementById('compare-panel').style.display = document.getElementById('compare-panel').style.display === 'none' || document.getElementById('compare-panel').style.display === '' ? 'block' : 'none';
                
                // Initialize comparison charts when panel is opened
                if (document.getElementById('compare-panel').style.display === 'block') {
                    initComparisonCharts();
                }
            });
            
            // Set up comparison panel close button
            document.getElementById('compare-close').addEventListener('click', function() {
                document.getElementById('compare-panel').style.display = 'none';
                document.getElementById('compare-btn').classList.remove('active');
            });
            
            // Set up export buttons
            document.getElementById('export-screenshot').addEventListener('click', takeScreenshot);
            document.getElementById('export-current-report').addEventListener('click', exportCurrentReport);
            document.getElementById('export-region-report').addEventListener('click', exportRegionReport);
            document.getElementById('export-geojson').addEventListener('click', exportGeoJSON);
            document.getElementById('export-esg-report').addEventListener('click', exportESGReport);
            document.getElementById('export-csv').addEventListener('click', exportCSV);
            
            // Set up measurement tools
            document.getElementById('measure-distance').addEventListener('click', startMeasuringDistance);
            document.getElementById('measure-area').addEventListener('click', startMeasuringArea);
            document.getElementById('measure-clear').addEventListener('click', clearMeasurements);
            document.getElementById('go-to-location').addEventListener('click', goToLocation);
            
            // Set up map click handler for location info
            if (window.map) {
                window.map.on('click', showLocationInfo);
            } else {
                console.error('Map not initialized before UI setup');
            }
            
            // Set up apply and reset filter buttons
            document.getElementById('apply-filters').addEventListener('click', applyFilters);
            document.getElementById('reset-filters').addEventListener('click', resetFilters);
        }
        
        // Initialize the main map
        function initMap() {
            // Initialize the map centered on Australia
            window.map = L.map('map').setView([-25.2744, 133.7751], 4);
            
            // Add the base map layer
            const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(window.map);
            
            // Add a satellite layer option
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });
            
            // Layer groups to manage different data layers
            window.layers = {
                events: L.layerGroup().addTo(window.map),
                dailyRainfall: L.layerGroup(),
                twelveMonthRainfall: L.layerGroup(),
                thirtySixMonthRainfall: L.layerGroup(),
                customLocations: L.layerGroup().addTo(window.map),
                floodWarnings: L.layerGroup(),
                floodPolygons: L.layerGroup(),
                measurementLayer: L.layerGroup().addTo(window.map),
                riskAssessment: L.layerGroup()
            };
            
            // Initialize heatmap layer (empty at first)
            // Check if L.heatLayer is available
            if (typeof L.heatLayer === 'function') {
                window.heatmapLayer = L.heatLayer([], {
                    radius: 25,
                    blur: 15,
                    maxZoom: 10,
                    gradient: {0.4: 'blue', 0.6: 'cyan', 0.7: 'lime', 0.8: 'yellow', 1.0: 'red'}
                });
            } else {
                console.warn('L.heatLayer is not available - Leaflet.heat plugin might not be loaded');
                // Create a mock heatmapLayer to prevent errors
                window.heatmapLayer = L.layerGroup();
            }
            
            // Add layer control
            const baseMaps = {
                "OpenStreetMap": baseLayer,
                "Satellite": satelliteLayer
            };
            
            const overlayMaps = {
                "Weather Events": window.layers.events,
                "Daily Rainfall": window.layers.dailyRainfall,
                "12-Month Rainfall": window.layers.twelveMonthRainfall,
                "36-Month Rainfall": window.layers.thirtySixMonthRainfall,
                "Custom Locations": window.layers.customLocations,
                "Flood Warnings": window.layers.floodWarnings,
                "Flood Polygons": window.layers.floodPolygons
            };
            
            L.control.layers(baseMaps, overlayMaps).addTo(window.map);
            
            // Add custom locations (example data)
            const customLocations = [
                { name: "Brisbane CBD", latitude: -27.4698, longitude: 153.0251 },
                { name: "Sydney Harbour", latitude: -33.8568, longitude: 151.2153 },
                { name: "Melbourne City", latitude: -37.8136, longitude: 144.9631 },
                { name: "Perth City", latitude: -31.9505, longitude: 115.8605 },
                { name: "Adelaide City", latitude: -34.9285, longitude: 138.6007 }
            ];
            
            // Add locations to the map
            customLocations.forEach(location => {
                const marker = L.marker([location.latitude, location.longitude]).addTo(window.layers.customLocations);
                marker.bindPopup(`<b>${location.name}</b><br>Lat: ${location.latitude.toFixed(4)}<br>Long: ${location.longitude.toFixed(4)}`);
            });
        }
        
        // Initialize the mini-map in the ESG panel
        function initMiniMap() {
            // Create mini map for visualization preview
            window.miniMap = L.map('mini-map').setView([-25.2744, 133.7751], 4);
            
            // Add base tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(window.miniMap);
            
            // Initialize with a default view
            updateMiniMap('qld', 'high', 'current', 'heatmap');
        }
        
        // Initialize all charts in the ESG panel
        function initCharts() {
            // Risk Factors Radar Chart
            const riskFactorsCtx = document.getElementById('risk-factors-radar').getContext('2d');
            const riskFactorsChart = new Chart(riskFactorsCtx, {
                type: 'radar',
                data: {
                    labels: ['Flood', 'Cyclone', 'Bushfire', 'Drought', 'Sea Level Rise', 'Heat Wave', 'Storm Surge'],
                    datasets: [{
                        label: 'Current Risk',
                        data: [85, 45, 60, 70, 40, 65, 55],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
                    }, {
                        label: '2050 Projection',
                        data: [95, 65, 80, 85, 75, 90, 70],
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(255, 99, 132, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    elements: {
                        line: {
                            tension: 0.1
                        }
                    },
                    scale: {
                        ticks: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
            
            // Physical Risk Gauge
            createGaugeChart('physical-risk-gauge', 74, '#dc3545');
            
            // Transition Risk Gauge
            createGaugeChart('transition-risk-gauge', 52, '#ffc107');
            
            // Regulatory Risk Gauge
            createGaugeChart('regulatory-risk-gauge', 38, '#0d6efd');
            
            // Flood Risk Chart
            const floodRiskCtx = document.getElementById('flood-risk-chart').getContext('2d');
            const floodRiskChart = new Chart(floodRiskCtx, {
                type: 'bar',
                data: {
                    labels: ['QLD', 'NSW', 'VIC', 'WA', 'SA', 'TAS', 'NT'],
                    datasets: [{
                        label: 'Current Risk Score',
                        data: [85, 72, 45, 30, 28, 15, 25],
                        backgroundColor: 'rgba(220, 53, 69, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
            
            // Insurance Impact Chart
            const insuranceImpactCtx = document.getElementById('insurance-impact-chart').getContext('2d');
            const insuranceImpactChart = new Chart(insuranceImpactCtx, {
                type: 'line',
                data: {
                    labels: ['Current', '2026', '2027', '2028', '2029', '2030'],
                    datasets: [{
                        label: 'Premium Impact (%)',
                        data: [0, 12, 18, 25, 32, 38],
                        borderColor: 'rgba(13, 110, 253, 1)',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        fill: true
                    }, {
                        label: 'Coverage Availability (%)',
                        data: [100, 95, 90, 82, 75, 68],
                        borderColor: 'rgba(25, 135, 84, 1)',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
            
            // Historical Chart
            const historicalCtx = document.getElementById('historical-chart').getContext('2d');
            const historicalChart = new Chart(historicalCtx, {
                type: 'line',
                data: {
                    labels: ['1980s', '1990s', '2000s', '2010s', '2020s'],
                    datasets: [{
                        label: 'Flood Events',
                        data: [15, 22, 28, 35, 42],
                        borderColor: 'rgba(13, 110, 253, 1)',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Update historical chart when metric changes
            document.getElementById('historical-metric').addEventListener('change', function() {
                const metric = this.value;
                let data, label;
                
                switch(metric) {
                    case 'frequency':
                        data = [15, 22, 28, 35, 42];
                        label = 'Flood Events';
                        break;
                    case 'intensity':
                        data = [35, 40, 52, 65, 78];
                        label = 'Intensity Score';
                        break;
                    case 'duration':
                        data = [4, 5, 7, 9, 12];
                        label = 'Avg. Duration (days)';
                        break;
                    case 'damage':
                        data = [2, 5, 12, 25, 38];
                        label = 'Economic Impact (B$)';
                        break;
                }
                
                historicalChart.data.datasets[0].data = data;
                historicalChart.data.datasets[0].label = label;
                historicalChart.update();
            });
        }
        
        // Create a gauge chart
        function createGaugeChart(id, value, color) {
            const ctx = document.getElementById(id).getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [value, 100 - value],
                        backgroundColor: [color, '#f5f5f5'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '75%',
                    responsive: true,
                    maintainAspectRatio: false,
                    legend: {
                        display: false
                    },
                    tooltips: {
                        enabled: false
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true
                    }
                }
            });
        }
        
        // Set up interactive filters for the ESG panel
        function setupInteractiveFilters() {
            const regionSelect = document.getElementById('analysis-region');
            const riskSelect = document.getElementById('risk-level');
            const scenarioSelect = document.getElementById('time-scenario');
            const visTypeSelect = document.getElementById('visualization-type');
            
            // Add event listeners to update the minimap when selections change
            regionSelect.addEventListener('change', updateFilters);
            riskSelect.addEventListener('change', updateFilters);
            scenarioSelect.addEventListener('change', updateFilters);
            visTypeSelect.addEventListener('change', updateFilters);
            
            function updateFilters() {
                const region = regionSelect.value;
                const riskLevel = riskSelect.value;
                const scenario = scenarioSelect.value;
                const visType = visTypeSelect.value;
                
                updateMiniMap(region, riskLevel, scenario, visType);
                updateRegionStats(region, riskLevel, scenario);
            }
        }
        
        // Update the mini map based on selected parameters
        function updateMiniMap(region, riskLevel, scenario, visType) {
            // Clear previous layers
            window.miniMap.eachLayer(layer => {
                if (layer instanceof L.TileLayer) return; // Keep base layer
                window.miniMap.removeLayer(layer);
            });
            
            // Set map view based on region
            let centerLat, centerLng, zoomLevel;
            
            if (region === 'qld') {
                centerLat = -23.5;
                centerLng = 144.0;
                zoomLevel = 6;
            } else if (region === 'nsw') {
                centerLat = -32.0;
                centerLng = 147.0;
                zoomLevel = 6;
            } else if (region === 'vic') {
                centerLat = -37.0;
                centerLng = 144.0;
                zoomLevel = 7;
            } else if (region === 'wa') {
                centerLat = -27.0;
                centerLng = 122.0;
                zoomLevel = 5;
            } else {
                centerLat = -25.0;
                centerLng = 135.0;
                zoomLevel = 4;
            }
            
            window.miniMap.setView([centerLat, centerLng], zoomLevel);
            
            // Add visualization based on type
            if (visType === 'heatmap') {
                // Add a circle to simulate heatmap
                L.circle([centerLat, centerLng], {
                    color: riskLevel === 'high' ? '#dc3545' : 
                           riskLevel === 'medium' ? '#ffc107' : '#28a745',
                    fillColor: riskLevel === 'high' ? '#dc3545' : 
                               riskLevel === 'medium' ? '#ffc107' : '#28a745',
                    fillOpacity: 0.3,
                    radius: 100000
                }).addTo(window.miniMap);
            } else if (visType === 'markers') {
                // Add markers
                for (let i = 0; i < 5; i++) {
                    const latOffset = Math.random() * 5 - 2.5;
                    const lngOffset = Math.random() * 5 - 2.5;
                    
                    L.circleMarker([centerLat + latOffset, centerLng + lngOffset], {
                        radius: 8,
                        fillColor: riskLevel === 'high' ? '#dc3545' : 
                                  riskLevel === 'medium' ? '#ffc107' : '#28a745',
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(window.miniMap);
                }
            } else if (visType === 'icons') {
                // Create custom icon
                const iconUrl = riskLevel === 'high' ? 'https://cdn-icons-png.flaticon.com/512/6357/6357049.png' : 
                                riskLevel === 'medium' ? 'https://cdn-icons-png.flaticon.com/512/6357/6357047.png' : 
                                'https://cdn-icons-png.flaticon.com/512/6357/6357048.png';
                
                const riskIcon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });
                
                // Add icons
                for (let i = 0; i < 5; i++) {
                    const latOffset = Math.random() * 5 - 2.5;
                    const lngOffset = Math.random() * 5 - 2.5;
                    
                    L.marker([centerLat + latOffset, centerLng + lngOffset], {
                        icon: riskIcon
                    }).addTo(window.miniMap);
                }
            }
        }
        
        // Update the main map based on selected parameters
        function updateMainMap(region, riskLevel, scenario, visType, clearLayers = false) {
            // Optionally clear existing custom layers
            if (clearLayers) {
                window.map.eachLayer(layer => {
                    if (layer instanceof L.TileLayer) return; // Keep base tile layer
                    if (layer._leaflet_id && window.map._layers[layer._leaflet_id]) {
                        window.map.removeLayer(layer);
                    }
                });
            }
            
            // Set center and zoom based on region
            let centerLat, centerLng, zoomLevel;
            
            if (region === 'qld') {
                centerLat = -23.5;
                centerLng = 144.0;
                zoomLevel = 6;
            } else if (region === 'nsw') {
                centerLat = -32.0;
                centerLng = 147.0;
                zoomLevel = 6;
            } else if (region === 'vic') {
                centerLat = -37.0;
                centerLng = 144.0;
                zoomLevel = 7;
            } else if (region === 'wa') {
                centerLat = -27.0;
                centerLng = 122.0;
                zoomLevel = 5;
            } else {
                centerLat = -25.0;
                centerLng = 135.0;
                zoomLevel = 4;
            }
            
            window.map.setView([centerLat, centerLng], zoomLevel);
            
            // Add visualization based on type
            if (visType === 'heatmap') {
                // Add a circle to simulate heatmap
                L.circle([centerLat, centerLng], {
                    color: riskLevel === 'high' ? '#dc3545' : 
                           riskLevel === 'medium' ? '#ffc107' : '#28a745',
                    fillColor: riskLevel === 'high' ? '#dc3545' : 
                               riskLevel === 'medium' ? '#ffc107' : '#28a745',
                    fillOpacity: 0.3,
                    radius: 300000
                }).addTo(window.map);
            } else if (visType === 'markers') {
                // Add markers
                for (let i = 0; i < 10; i++) {
                    const latOffset = Math.random() * 8 - 4;
                    const lngOffset = Math.random() * 8 - 4;
                    
                    L.circleMarker([centerLat + latOffset, centerLng + lngOffset], {
                        radius: 8,
                        fillColor: riskLevel === 'high' ? '#dc3545' : 
                                  riskLevel === 'medium' ? '#ffc107' : '#28a745',
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(window.map);
                }
            } else if (visType === 'icons') {
                // Create custom icon
                const iconUrl = riskLevel === 'high' ? 'https://cdn-icons-png.flaticon.com/512/6357/6357049.png' : 
                                riskLevel === 'medium' ? 'https://cdn-icons-png.flaticon.com/512/6357/6357047.png' : 
                                'https://cdn-icons-png.flaticon.com/512/6357/6357048.png';
                
                const riskIcon = L.icon({
                    iconUrl: iconUrl,
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                });
                
                // Add icons
                for (let i = 0; i < 10; i++) {
                    const latOffset = Math.random() * 8 - 4;
                    const lngOffset = Math.random() * 8 - 4;
                    
                    L.marker([centerLat + latOffset, centerLng + lngOffset], {
                        icon: riskIcon
                    }).addTo(window.map);
                }
            }
        }
        
        // Update region statistics in the ESG panel
        function updateRegionStats(region, riskLevel, scenario) {
            const statsContainer = document.getElementById('region-stats-content');
            const regionName = getRegionName(region);
            
            let riskScore, impactLevel, projectedChange, recommendations;
            
            // Determine values based on parameters
            if (region === 'qld') {
                riskScore = riskLevel === 'high' ? 85 : riskLevel === 'medium' ? 65 : 45;
                impactLevel = riskLevel === 'high' ? 'Severe' : riskLevel === 'medium' ? 'Moderate' : 'Low';
                projectedChange = scenario === '2050' ? '+45%' : scenario === '2030' ? '+25%' : '+15%';
                recommendations = 'Implement enhanced structural reinforcement';
            } else if (region === 'nsw') {
                riskScore = riskLevel === 'high' ? 78 : riskLevel === 'medium' ? 58 : 38;
                impactLevel = riskLevel === 'high' ? 'Severe' : riskLevel === 'medium' ? 'Moderate' : 'Low';
                projectedChange = scenario === '2050' ? '+40%' : scenario === '2030' ? '+22%' : '+12%';
                recommendations = 'Improve drainage systems';
            } else if (region === 'vic') {
                riskScore = riskLevel === 'high' ? 65 : riskLevel === 'medium' ? 45 : 25;
                impactLevel = riskLevel === 'high' ? 'Substantial' : riskLevel === 'medium' ? 'Moderate' : 'Low';
                projectedChange = scenario === '2050' ? '+35%' : scenario === '2030' ? '+18%' : '+8%';
                recommendations = 'Enhance flood barriers and warning systems';
            } else if (region === 'wa') {
                riskScore = riskLevel === 'high' ? 55 : riskLevel === 'medium' ? 35 : 15;
                impactLevel = riskLevel === 'high' ? 'Moderate' : riskLevel === 'medium' ? 'Low' : 'Minimal';
                projectedChange = scenario === '2050' ? '+30%' : scenario === '2030' ? '+15%' : '+5%';
                recommendations = 'Strengthen coastal defenses';
            } else {
                riskScore = riskLevel === 'high' ? 70 : riskLevel === 'medium' ? 50 : 30;
                impactLevel = riskLevel === 'high' ? 'Substantial' : riskLevel === 'medium' ? 'Moderate' : 'Low';
                projectedChange = scenario === '2050' ? '+38%' : scenario === '2030' ? '+20%' : '+10%';
                recommendations = 'Develop comprehensive national resilience plan';
            }
            
            const riskClass = riskLevel === 'high' ? 'danger' : riskLevel === 'medium' ? 'warning' : 'success';
            
            // Update content
            statsContainer.innerHTML = `
                <div class="row">
                    <div class="col-6">
                        <p class="mb-1"><strong>Risk Score:</strong></p>
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar bg-${riskClass}" role="progressbar" style="width: ${riskScore}%;" 
                                aria-valuenow="${riskScore}" aria-valuemin="0" aria-valuemax="100">${riskScore}%</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <p class="mb-1"><strong>Impact Level:</strong></p>
                        <span class="badge bg-${riskClass} p-2 d-block text-center">${impactLevel}</span>
                    </div>
                </div>
                <div class="mt-2">
                    <p class="mb-1"><strong>Projected Change:</strong> ${projectedChange}</p>
                    <p class="mb-1"><strong>Key Recommendation:</strong> ${recommendations}</p>
                </div>
                <div class="mt-2 text-end">
                    <small class="text-muted">Region: ${regionName} | Scenario: ${scenario}</small>
                </div>
            `;
        }
        
        // Add an engineering report overlay to the map
        function addEngineeringReportOverlay(region, riskLevel, scenario) {
            // Remove any existing report overlay
            if (window.reportOverlay) {
                window.reportOverlay.remove();
            }
            
            // Create report control
            const ReportControl = L.Control.extend({
                options: {
                    position: 'topright'
                },
                
                onAdd: function() {
                    const container = L.DomUtil.create('div', 'engineering-report-container');
                    container.style.cssText = `
                        background-color: white;
                        padding: 15px;
                        border-radius: 8px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                        min-width: 300px;
                        max-width: 400px;
                        max-height: 80vh;
                        overflow-y: auto;
                    `;
                    
                    // Get region name
                    let regionName = getRegionName(region);
                    
                    // Get scenario label
                    let scenarioLabel;
                    if (scenario === 'current') scenarioLabel = 'Current (2025)';
                    else if (scenario === '2030') scenarioLabel = 'Future (2030)';
                    else if (scenario === '2050') scenarioLabel = 'Future (2050)';
                    else scenarioLabel = 'Current';
                    
                    // Get risk level label
                    let riskLevelLabel = riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1);
                    if (riskLevel === 'all') riskLevelLabel = 'All Risk Levels';
                    
                    // Create report content
                    container.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="mb-0">Engineering Report</h4>
                            <button class="btn-close" id="close-report"></button>
                        </div>
                        <div class="alert alert-primary">
                            <strong>${regionName} ${scenarioLabel} Analysis</strong><br>
                            <span class="small">Risk Assessment: ${riskLevelLabel}</span>
                        </div>
                        <div class="mb-3">
                            <h5>Executive Summary</h5>
                            <p>Based on Bureau of Meteorology data and engineering assessment, the ${regionName} region shows significant climate-related risks requiring immediate attention.</p>
                        </div>
                        <div class="mb-3">
                            <h5>Key Findings</h5>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item bg-transparent">
                                    <i class="fas fa-exclamation-triangle text-danger me-2"></i> Extreme rainfall recorded at multiple stations
                                </li>
                                <li class="list-group-item bg-transparent">
                                    <i class="fas fa-chart-line text-warning me-2"></i> Increasing trend in major flood events
                                </li>
                                <li class="list-group-item bg-transparent">
                                    <i class="fas fa-building text-primary me-2"></i> Critical infrastructure potentially impacted
                                </li>
                            </ul>
                        </div>
                        <div class="mb-3">
                            <h5>Recommendation</h5>
                            <p>Implement enhanced structural reinforcement and elevate critical equipment to reduce impact. Install early warning systems and develop comprehensive evacuation plans.</p>
                        </div>
                        <div class="text-end mt-3">
                            <span class="text-muted small">Report generated by</span><br>
                            <span class="fw-bold">Sophie Griffin</span><br>
                            <span class="small">Climate & Sustainability Practice Lead</span><br>
                            <span class="small text-muted">Gallagher Australia</span>
                        </div>
                    `;
                    
                    // Add close button functionality
                    setTimeout(() => {
                        const closeBtn = document.getElementById('close-report');
                        if (closeBtn) {
                            closeBtn.addEventListener('click', function() {
                                container.remove();
                                if (window.reportOverlay) {
                                    window.reportOverlay.remove();
                                    window.reportOverlay = null;
                                }
                                
                                // Also remove pulse marker
                                if (window.pulseMarker) {
                                    window.map.removeLayer(window.pulseMarker);
                                    window.pulseMarker = null;
                                }
                            });
                        }
                    }, 100);
                    
                    return container;
                }
            });
            
            // Add the report to the map
            window.reportOverlay = new ReportControl();
            window.map.addControl(window.reportOverlay);
            
            // Add a pulsing marker at the center of the region
            let centerLat, centerLng;
            if (region === 'qld') {
                centerLat = -23.5;
                centerLng = 144.0;
            } else if (region === 'nsw') {
                centerLat = -32.0;
                centerLng = 147.0;
            } else if (region === 'vic') {
                centerLat = -37.0;
                centerLng = 144.0;
            } else if (region === 'wa') {
                centerLat = -27.0;
                centerLng = 122.0;
            } else {
                centerLat = -25.0;
                centerLng = 135.0;
            }
            
            // Add pulsing effect
            const pulseIcon = L.divIcon({
                html: '<div class="pulse-marker"></div>',
                className: '',
                iconSize: [20, 20]
            });
            
            // Add marker
            if (window.pulseMarker) {
                window.map.removeLayer(window.pulseMarker);
            }
            
            window.pulseMarker = L.marker([centerLat, centerLng], {
                icon: pulseIcon
            }).addTo(window.map);
        }
        
        // Helper function to get region name from code
        function getRegionName(region) {
            switch(region) {
                case 'qld': return 'Queensland';
                case 'nsw': return 'New South Wales';
                case 'vic': return 'Victoria';
                case 'wa': return 'Western Australia';
                case 'sa': return 'South Australia';
                case 'tas': return 'Tasmania';
                case 'nt': return 'Northern Territory';
                case 'act': return 'Australian Capital Territory';
                default: return 'National';
            }
        }
        
        // Show a toast notification
        function showToast(message) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toastContainer.appendChild(toast);
            
            // Show the toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Hide and remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toastContainer.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // Apply filter changes from the filter panel
        function applyFilters() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const region = document.getElementById('region-filter').value;
            const severity = document.getElementById('severity-filter').value;
            
            // Collect event types
            const eventTypes = [];
            if (document.getElementById('type-flood').checked) eventTypes.push('flood');
            if (document.getElementById('type-cyclone').checked) eventTypes.push('cyclone');
            if (document.getElementById('type-fire').checked) eventTypes.push('bushfire');
            if (document.getElementById('type-storm').checked) eventTypes.push('storm');
            
            // Apply filters - this would typically filter data layers
            // For this demo, just show a notification
            showToast('Filters applied successfully');
            
            // Hide filter panel
            document.getElementById('filter-panel').style.display = 'none';
            document.getElementById('filter-btn').classList.remove('active');
        }
        
        // Reset filters to default
        function resetFilters() {
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            document.getElementById('region-filter').value = 'all';
            document.getElementById('severity-filter').value = '1';
            
            // Reset checkboxes
            document.getElementById('type-flood').checked = true;
            document.getElementById('type-cyclone').checked = true;
            document.getElementById('type-fire').checked = true;
            document.getElementById('type-storm').checked = true;
            
            // Show notification
            showToast('Filters reset to default');
        }
        
        // Update flood layer visibility based on toggle state
        function updateFloodLayerVisibility() {
            const warningsToggle = document.getElementById('flood-warnings-visibility');
            const polygonsToggle = document.getElementById('flood-polygons-visibility');
            
            // Hardcoded flood warnings from flood_functions.js
            if (warningsToggle && window.floodWarningLayer) {
                if (warningsToggle.checked) {
                    window.map.addLayer(window.floodWarningLayer);
                } else {
                    window.map.removeLayer(window.floodWarningLayer);
                }
            }
            
            // Hardcoded flood polygons from flood_functions.js
            if (polygonsToggle && window.floodPolygonLayer) {
                if (polygonsToggle.checked) {
                    window.map.addLayer(window.floodPolygonLayer);
                } else {
                    window.map.removeLayer(window.floodPolygonLayer);
                }
            }
            
            // User-uploaded flood warnings
            if (window.floodWarningsData && warningsToggle) {
                const floodWarningLayer = window.floodWarningLayer || L.layerGroup();
                
                if (warningsToggle.checked) {
                    window.map.addLayer(floodWarningLayer);
                } else {
                    window.map.removeLayer(floodWarningLayer);
                }
            }
            
            // User-uploaded flood polygons
            if (window.floodPolygonsData && polygonsToggle) {
                const floodPolygonLayer = window.floodPolygonLayer || L.layerGroup();
                
                if (polygonsToggle.checked) {
                    window.map.addLayer(floodPolygonLayer);
                } else {
                    window.map.removeLayer(floodPolygonLayer);
                }
            }
        }
        
        // Update heatmap with rainfall data
        function updateHeatmap() {
            // Clear existing heatmap data
            if (window.heatmapLayer) {
                window.map.removeLayer(window.heatmapLayer);
            }
            
            // Collect points for heatmap
            const heatPoints = [];
            
            // Use rainfall data if available
            if (window.rainfallData && window.rainfallData.length > 0) {
                window.rainfallData.forEach(station => {
                    // Extract coordinates
                    let lat = null, lng = null;
                    
                    // Try to find lat/long in various formats
                    const latFields = ['Latitude (°)', 'Latitude (Â°)', 'Latitude', 'Latitude (deg)'];
                    const lonFields = ['Longitude (°)', 'Longitude (Â°)', 'Longitude', 'Longitude (deg)'];
                    
                    for (const field of latFields) {
                        if (station[field] !== undefined && station[field] !== null) {
                            lat = parseFloat(station[field]);
                            break;
                        }
                    }
                    
                    for (const field of lonFields) {
                        if (station[field] !== undefined && station[field] !== null) {
                            lng = parseFloat(station[field]);
                            break;
                        }
                    }
                    
                    // If we have coordinates and rainfall data
                    if (!isNaN(lat) && !isNaN(lng)) {
                        // Get rainfall value
                        let intensity = 0;
                        if (station['12-month rainfall'] || station['12 month rainfall']) {
                            intensity = parseFloat(station['12-month rainfall'] || station['12 month rainfall'] || 0);
                        }
                        
                        // Add to heatmap points with intensity
                        if (!isNaN(intensity) && intensity > 0) {
                            heatPoints.push([lat, lng, Math.min(intensity / 10, 1)]); // Normalize intensity
                        }
                    }
                });
            } else {
                // Use flood warning data as fallback
                if (window.floodWarningsData && window.floodWarningsData.length > 0) {
                    window.floodWarningsData.forEach(warning => {
                        let centerLat, centerLng;
                        
                        if (warning.state === 'Queensland') {
                            centerLat = -23.5;
                            centerLng = 144.0;
                        } else if (warning.state === 'New South Wales') {
                            centerLat = -32.0;
                            centerLng = 147.0;
                        } else {
                            centerLat = -25.0;
                            centerLng = 134.0;
                        }
                        
                        // Add some randomness to spread out points
                        for (let i = 0; i < 5; i++) {
                            const lat = centerLat + (Math.random() * 4 - 2);
                            const lng = centerLng + (Math.random() * 4 - 2);
                            const intensity = warning.severity === 'Severe' ? 1 : 
                                         warning.severity === 'Moderate' ? 0.7 : 0.4;
                            
                            heatPoints.push([lat, lng, intensity]);
                        }
                    });
                } else {
                    // Default fallback points around major cities
                    const defaultPoints = [
                        [-33.8688, 151.2093, 0.8], // Sydney
                        [-37.8136, 144.9631, 0.7], // Melbourne
                        [-27.4698, 153.0251, 0.9], // Brisbane
                        [-31.9505, 115.8605, 0.4], // Perth
                        [-34.9285, 138.6007, 0.5]  // Adelaide
                    ];
                    
                    heatPoints.push(...defaultPoints);
                }
            }
            
            // Update heatmap layer with new points
            window.heatmapLayer = L.heatLayer(heatPoints, {
                radius: 25,
                blur: 15,
                maxZoom: 10,
                gradient: {0.4: 'blue', 0.6: 'cyan', 0.7: 'lime', 0.8: 'yellow', 1.0: 'red'}
            });
            
            showToast('Heatmap generated with ' + heatPoints.length + ' data points');
        }
        
        // Generate risk assessment layer
        function generateRiskLayer() {
            // Clear existing risk layer
            window.layers.riskAssessment.clearLayers();
            
            // Define risk regions
            const riskRegions = [
                {
                    name: 'Queensland Coast',
                    center: [-20.9176, 148.9663],
                    radius: 400000,
                    riskLevel: 'high',
                    fillColor: '#dc3545',
                    details: 'High risk of cyclones and flooding in coastal regions'
                },
                {
                    name: 'New South Wales Rivers',
                    center: [-31.2532, 146.9211],
                    radius: 300000,
                    riskLevel: 'medium',
                    fillColor: '#ffc107',
                    details: 'Medium risk of river flooding during heavy rainfall periods'
                },
                {
                    name: 'Victoria Bushfire Zone',
                    center: [-37.0201, 144.9646],
                    radius: 250000,
                    riskLevel: 'medium',
                    fillColor: '#fd7e14',
                    details: 'Medium risk of bushfires affecting flood response capabilities'
                },
                {
                    name: 'Northern Territory Monsoon',
                    center: [-12.4634, 130.8456],
                    radius: 350000,
                    riskLevel: 'high',
                    fillColor: '#dc3545',
                    details: 'High risk of seasonal flooding during monsoon season'
                },
                {
                    name: 'Western Australia Drought',
                    center: [-25.0, 120.0],
                    radius: 500000,
                    riskLevel: 'low',
                    fillColor: '#28a745',
                    details: 'Low flood risk but high water scarcity risk'
                }
            ];
            
            // Add each risk region to the map
            riskRegions.forEach(region => {
                const circle = L.circle([region.center[0], region.center[1]], {
                    radius: region.radius,
                    color: region.fillColor,
                    fillColor: region.fillColor,
                    fillOpacity: 0.2,
                    weight: 2
                });
                
                // Create marker at the center
                const marker = L.marker([region.center[0], region.center[1]], {
                    icon: L.divIcon({
                        className: 'risk-marker',
                        html: `<div style="background-color: ${region.fillColor}; width: 24px; height: 24px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${region.riskLevel.charAt(0).toUpperCase()}</div>`,
                        iconSize: [24, 24]
                    })
                });
                
                // Create popup content
                const popupContent = `
                    <div style="max-width: 300px;">
                        <h5>${region.name}</h5>
                        <p><strong>Risk Level:</strong> <span class="badge bg-${region.riskLevel === 'high' ? 'danger' : (region.riskLevel === 'medium' ? 'warning' : 'success')}">${region.riskLevel.toUpperCase()}</span></p>
                        <p>${region.details}</p>
                        <button class="btn btn-sm btn-primary generate-report" data-region="${region.name}" data-risk="${region.riskLevel}">Generate Report</button>
                    </div>
                `;
                
                // Bind popup
                circle.bindPopup(popupContent);
                marker.bindPopup(popupContent);
                
                // Add to risk assessment layer
                window.layers.riskAssessment.addLayer(circle);
                window.layers.riskAssessment.addLayer(marker);
            });
            
            // Add to map
            window.map.addLayer(window.layers.riskAssessment);
            
            showToast('Risk assessment layer generated with ' + riskRegions.length + ' regions');
            
            // Add event listener for generate report buttons in popups
            setTimeout(() => {
                document.querySelectorAll('.generate-report').forEach(button => {
                    button.addEventListener('click', function() {
                        const region = this.getAttribute('data-region');
                        const riskLevel = this.getAttribute('data-risk');
                        
                        // Generate a report for this region
                        const reportHtml = `
                            <div class="report-container">
                                <h4>${region} Risk Assessment</h4>
                                <p><strong>Risk Level:</strong> ${riskLevel.toUpperCase()}</p>
                                <p>This report provides detailed analysis of flood risks in the ${region} area.</p>
                                <button class="btn btn-primary" id="save-report">Save Report</button>
                            </div>
                        `;
                        
                        showToast(`Report generated for ${region}`);
                    });
                });
            }, 500);
        }
        
        // Measurement tools
        function startMeasuringDistance() {
            clearMeasurements();
            showToast('Click on the map to start measuring distance');
            
            let points = [];
            let lines = [];
            let measuring = true;
            
            // Click handler for measuring
            const onMapClick = function(e) {
                if (!measuring) return;
                
                // Add point to the measurement
                points.push(e.latlng);
                
                // Create marker at the point
                const marker = L.circleMarker(e.latlng, {
                    radius: 5,
                    color: '#0d6efd',
                    fillColor: '#0d6efd',
                    fillOpacity: 1
                }).addTo(window.layers.measurementLayer);
                
                // If this is at least the second point, draw a line
                if (points.length > 1) {
                    const line = L.polyline([points[points.length - 2], points[points.length - 1]], {
                        color: '#0d6efd',
                        weight: 3,
                        dashArray: '5, 10'
                    }).addTo(window.layers.measurementLayer);
                    
                    lines.push(line);
                    
                    // Calculate distance for this segment
                    const lastPoint = points[points.length - 2];
                    const newPoint = points[points.length - 1];
                    const distance = lastPoint.distanceTo(newPoint);
                    
                    // Add label for this segment
                    const midPoint = L.latLng(
                        (lastPoint.lat + newPoint.lat) / 2,
                        (lastPoint.lng + newPoint.lng) / 2
                    );
                    
                    const label = L.marker(midPoint, {
                        icon: L.divIcon({
                            className: 'distance-label',
                            html: `<div class="bg-white px-2 py-1 rounded shadow-sm">${formatDistance(distance)}</div>`,
                            iconSize: [80, 20],
                            iconAnchor: [40, 10]
                        })
                    }).addTo(window.layers.measurementLayer);
                    
                    // Update total distance
                    let totalDistance = 0;
                    for (let i = 1; i < points.length; i++) {
                        totalDistance += points[i-1].distanceTo(points[i]);
                    }
                    
                    // Show in location info
                    document.getElementById('location-info').style.display = 'block';
                    document.getElementById('location-info').innerHTML = `
                        <strong>Total Distance:</strong> ${formatDistance(totalDistance)}<br>
                        <strong>Points:</strong> ${points.length}<br>
                        <small>Click "Clear Measurements" to finish</small>
                    `;
                }
            };
            
            // Add click handler
            window.map.on('click', onMapClick);
            
            // Store handler to remove it later
            window.currentMeasurementHandler = onMapClick;
        }
        
        function startMeasuringArea() {
            clearMeasurements();
            showToast('Click on the map to define an area. Click near the first point to close it.');
            
            let points = [];
            let polygon = null;
            let markers = [];
            let measuring = true;
            
            // Click handler for measuring
            const onMapClick = function(e) {
                if (!measuring) return;
                
                // Check if we're closing the polygon
                if (points.length > 2) {
                    const firstPoint = points[0];
                    const distanceToFirst = e.latlng.distanceTo(firstPoint);
                    
                    if (distanceToFirst < 50000) { // Within 50km of the first point
                        // Close the polygon
                        points.push(firstPoint);
                        
                        // Remove existing incomplete polygon
                        if (polygon) {
                            window.layers.measurementLayer.removeLayer(polygon);
                        }
                        
                        // Create final polygon
                        polygon = L.polygon(points, {
                            color: '#0d6efd',
                            weight: 3,
                            fillColor: '#0d6efd',
                            fillOpacity: 0.2
                        }).addTo(window.layers.measurementLayer);
                        
                        // Calculate area
                        const area = L.GeometryUtil.geodesicArea(polygon.getLatLngs()[0]);
                        
                        // Add label in the center of the polygon
                        const center = polygon.getBounds().getCenter();
                        
                        const label = L.marker(center, {
                            icon: L.divIcon({
                                className: 'area-label',
                                html: `<div class="bg-white px-2 py-1 rounded shadow-sm">${formatArea(area)}</div>`,
                                iconSize: [100, 20],
                                iconAnchor: [50, 10]
                            })
                        }).addTo(window.layers.measurementLayer);
                        
                        // Show in location info
                        document.getElementById('location-info').style.display = 'block';
                        document.getElementById('location-info').innerHTML = `
                            <strong>Area:</strong> ${formatArea(area)}<br>
                            <strong>Perimeter:</strong> ${formatDistance(calculatePerimeter(points))}<br>
                            <small>Click "Clear Measurements" to start over</small>
                        `;
                        
                        // Stop measuring
                        measuring = false;
                        
                        return;
                    }
                }
                
                // Add point to the measurement
                points.push(e.latlng);
                
                // Create marker at the point
                const marker = L.circleMarker(e.latlng, {
                    radius: 5,
                    color: '#0d6efd',
                    fillColor: '#0d6efd',
                    fillOpacity: 1
                }).addTo(window.layers.measurementLayer);
                
                markers.push(marker);
                
                // If we have at least 3 points, create or update the polygon
                if (points.length >= 3) {
                    // Remove existing polygon
                    if (polygon) {
                        window.layers.measurementLayer.removeLayer(polygon);
                    }
                    
                    // Create new polygon
                    polygon = L.polygon(points, {
                        color: '#0d6efd',
                        weight: 3,
                        fillColor: '#0d6efd',
                        fillOpacity: 0.2
                    }).addTo(window.layers.measurementLayer);
                    
                    // Update location info with preliminary area
                    const area = L.GeometryUtil.geodesicArea(polygon.getLatLngs()[0]);
                    
                    document.getElementById('location-info').style.display = 'block';
                    document.getElementById('location-info').innerHTML = `
                        <strong>Area (incomplete):</strong> ${formatArea(area)}<br>
                        <strong>Points:</strong> ${points.length}<br>
                        <small>Click near the first point to complete the polygon</small>
                    `;
                } else if (points.length === 2) {
                    // Just a line so far
                    const line = L.polyline(points, {
                        color: '#0d6efd',
                        weight: 3
                    }).addTo(window.layers.measurementLayer);
                    
                    document.getElementById('location-info').style.display = 'block';
                    document.getElementById('location-info').innerHTML = `
                        <strong>Distance:</strong> ${formatDistance(points[0].distanceTo(points[1]))}<br>
                        <strong>Points:</strong> ${points.length}<br>
                        <small>Add more points to create an area</small>
                    `;
                }
            };
            
            // Add click handler
            window.map.on('click', onMapClick);
            
            // Store handler to remove it later
            window.currentMeasurementHandler = onMapClick;
        }
        
        // Clear all measurements
        function clearMeasurements() {
            // Clear measurement layer
            window.layers.measurementLayer.clearLayers();
            
            // Reset location info
            document.getElementById('location-info').style.display = 'none';
            
            // Remove any ongoing measurement handlers
            if (window.currentMeasurementHandler) {
                window.map.off('click', window.currentMeasurementHandler);
                window.currentMeasurementHandler = null;
            }
            
            showToast('Measurements cleared');
        }
        
        // Show location info when clicking on the map
        function showLocationInfo(e) {
            // Don't show if we're measuring
            if (window.currentMeasurementHandler) return;
            
            const latlng = e.latlng;
            const lat = latlng.lat.toFixed(6);
            const lng = latlng.lng.toFixed(6);
            
            // Show location info
            document.getElementById('location-info').style.display = 'block';
            document.getElementById('location-info').innerHTML = `
                <strong>Latitude:</strong> ${lat}<br>
                <strong>Longitude:</strong> ${lng}<br>
                <button class="btn btn-sm btn-outline-primary mt-1 copy-coords">Copy Coordinates</button>
            `;
            
            // Add event listener to copy button
            setTimeout(() => {
                const copyBtn = document.querySelector('.copy-coords');
                if (copyBtn) {
                    copyBtn.addEventListener('click', function() {
                        const coords = `${lat}, ${lng}`;
                        navigator.clipboard.writeText(coords).then(() => {
                            showToast('Coordinates copied to clipboard');
                        });
                    });
                }
            }, 100);
            
            // Update input field
            document.getElementById('lat-lng-input').value = `${lat}, ${lng}`;
        }
        
        // Go to a location by coordinates
        function goToLocation() {
            const input = document.getElementById('lat-lng-input').value;
            const coords = input.split(',');
            
            if (coords.length === 2) {
                const lat = parseFloat(coords[0].trim());
                const lng = parseFloat(coords[1].trim());
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    window.map.setView([lat, lng], 10);
                    
                    // Add a temporary marker
                    const marker = L.marker([lat, lng]).addTo(window.map);
                    setTimeout(() => {
                        window.map.removeLayer(marker);
                    }, 3000);
                    
                    showToast(`Location set to ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
                } else {
                    showToast('Invalid coordinates format');
                }
            } else {
                showToast('Please enter coordinates as "lat, lng"');
            }
        }
        
        // Export functions
        function takeScreenshot() {
            showToast('Screenshot would be captured here (HTML2Canvas would be used in production)');
            
            // In a real implementation, would use html2canvas like this:
            // html2canvas(document.querySelector("#map")).then(canvas => {
            //     const link = document.createElement('a');
            //     link.download = 'flood-risk-map.png';
            //     link.href = canvas.toDataURL('image/png');
            //     link.click();
            // });
        }
        
        function exportCurrentReport() {
            if (window.lastReportSettings) {
                const regionName = getRegionName(window.lastReportSettings.region);
                showToast(`Exporting PDF report for ${regionName} - would download in production`);
            } else {
                showToast('Please generate an engineering report first');
            }
        }
        
        function exportRegionReport() {
            showToast('Region report would be exported as a DOCX file');
        }
        
        function exportGeoJSON() {
            showToast('Visible layers would be exported as GeoJSON');
            
            // Example implementation (would actually work with proper serialization):
            // const geoJson = {
            //     type: 'FeatureCollection',
            //     features: []
            // };
            
            // // Serialize each visible layer
            // // This is a simplified example - would need layer-specific handling
            // window.map.eachLayer(layer => {
            //     if (layer.toGeoJSON) {
            //         geoJson.features.push(layer.toGeoJSON());
            //     }
            // });
            
            // // Create download
            // const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geoJson));
            // const downloadLink = document.createElement('a');
            // downloadLink.setAttribute("href", dataStr);
            // downloadLink.setAttribute("download", "map-data.geojson");
            // downloadLink.click();
        }
        
        function exportESGReport() {
            showToast('ESG Analytics Report would be exported as PDF');
        }
        
        function exportCSV() {
            showToast('Data would be exported as CSV');
            
            // Example implementation
            // const csvData = "data:text/csv;charset=utf-8,";
            // // Add headers
            // csvData += "Location,Risk Level,Rainfall,Events\n";
            
            // // Add data rows
            // if (window.rainfallData) {
            //     window.rainfallData.forEach(station => {
            //         csvData += `${station['Station name'] || 'Unknown'},Medium,${station['12-month rainfall'] || 0},0\n`;
            //     });
            // }
            
            // // Create download
            // const encodedUri = encodeURI(csvData);
            // const link = document.createElement("a");
            // link.setAttribute("href", encodedUri);
            // link.setAttribute("download", "flood-data.csv");
            // document.body.appendChild(link);
            // link.click();
        }
        
        // Helper functions
        function formatDistance(meters) {
            if (meters < 1000) {
                return Math.round(meters) + ' m';
            } else {
                return (meters / 1000).toFixed(2) + ' km';
            }
        }
        
        function formatArea(sqMeters) {
            if (sqMeters < 10000) {
                return Math.round(sqMeters) + ' m²';
            } else if (sqMeters < 1000000) {
                return (sqMeters / 10000).toFixed(2) + ' ha';
            } else {
                return (sqMeters / 1000000).toFixed(2) + ' km²';
            }
        }
        
        function calculatePerimeter(points) {
            let perimeter = 0;
            for (let i = 0; i < points.length - 1; i++) {
                perimeter += points[i].distanceTo(points[i + 1]);
            }
            // Close the loop
            if (points.length > 2) {
                perimeter += points[points.length - 1].distanceTo(points[0]);
            }
            return perimeter;
        }
        
        // Initialize Weather Charts
        function initWeatherCharts() {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js is not loaded');
                return;
            }
            
            // Sample data for the charts
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const rainfall = [45, 38, 65, 70, 55, 42, 30, 35, 55, 68, 72, 60];
            const historicalAvg = [40, 35, 60, 65, 50, 40, 28, 32, 50, 65, 68, 55];
            
            // Current rainfall chart
            const currentRainfallCtx = document.getElementById('current-rainfall-chart').getContext('2d');
            new Chart(currentRainfallCtx, {
                type: 'bar',
                data: {
                    labels: ['Current', 'Historical Avg', 'Last Year'],
                    datasets: [{
                        label: 'Monthly Rainfall (mm)',
                        data: [65, 52, 58],
                        backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(255, 206, 86, 0.7)'],
                        borderColor: ['rgba(54, 162, 235, 1)', 'rgba(75, 192, 192, 1)', 'rgba(255, 206, 86, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Rainfall (mm)'
                            }
                        }
                    }
                }
            });
            
            // Current flood risk gauge
            const riskGaugeCtx = document.getElementById('current-risk-gauge').getContext('2d');
            new Chart(riskGaugeCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Low', 'Medium', 'High'],
                    datasets: [{
                        data: [20, 35, 45],
                        backgroundColor: ['rgba(40, 167, 69, 0.7)', 'rgba(255, 193, 7, 0.7)', 'rgba(220, 53, 69, 0.7)'],
                        borderColor: ['rgba(40, 167, 69, 1)', 'rgba(255, 193, 7, 1)', 'rgba(220, 53, 69, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    circumference: 180,
                    rotation: 270,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Current Risk Level: Medium-High'
                        }
                    }
                }
            });
            
            // 7-day forecast chart
            const forecastCtx = document.getElementById('forecast-chart');
            if (forecastCtx) {
                const forecastChart = new Chart(forecastCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['Today', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
                        datasets: [{
                            label: 'Precipitation (mm)',
                            data: [5, 12, 8, 15, 25, 18, 7],
                            fill: true,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Precipitation (mm)'
                                }
                            }
                        }
                    }
                });
            }
            
            // Historical chart
            const historicalCtx = document.getElementById('historical-chart');
            if (historicalCtx) {
                const historicalChart = new Chart(historicalCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Actual Rainfall',
                            data: rainfall,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            fill: true
                        }, {
                            label: 'Historical Average',
                            data: historicalAvg,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            fill: true,
                            borderDash: [5, 5]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Rainfall (mm)'
                                }
                            }
                        }
                    }
                });
            }
            
            // Anomaly chart
            const anomalyCtx = document.getElementById('anomaly-chart');
            if (anomalyCtx) {
                const anomalyData = months.map((month, i) => rainfall[i] - historicalAvg[i]);
                
                const anomalyChart = new Chart(anomalyCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Rainfall Anomaly',
                            data: anomalyData,
                            backgroundColor: anomalyData.map(value => 
                                value > 0 ? 'rgba(54, 162, 235, 0.7)' : 'rgba(255, 99, 132, 0.7)'
                            ),
                            borderColor: anomalyData.map(value => 
                                value > 0 ? 'rgba(54, 162, 235, 1)' : 'rgba(255, 99, 132, 1)'
                            ),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Anomaly (mm)'
                                }
                            }
                        }
                    }
                });
            }
            
            // Populate weather events table
            const weatherEventsData = [
                { event: 'Heavy Rainfall', location: 'Brisbane', date: '2025-04-18', severity: 'High' },
                { event: 'Flash Flooding', location: 'Gold Coast', date: '2025-04-16', severity: 'Moderate' },
                { event: 'Thunderstorm', location: 'Sydney', date: '2025-04-15', severity: 'Moderate' },
                { event: 'River Flooding', location: 'Lismore', date: '2025-04-12', severity: 'High' }
            ];
            
            const tbody = document.getElementById('weather-events-tbody');
            if (tbody) {
                tbody.innerHTML = '';
                weatherEventsData.forEach(event => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${event.event}</td>
                        <td>${event.location}</td>
                        <td>${event.date}</td>
                        <td><span class="badge bg-${event.severity === 'High' ? 'danger' : 'warning'}">${event.severity}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            // Create forecast mini-map
            const forecastMap = document.getElementById('forecast-map');
            if (forecastMap && L) {
                // If a map already exists, destroy it first
                if (window.forecastMiniMap) {
                    window.forecastMiniMap.remove();
                }
                
                // Create new map
                window.forecastMiniMap = L.map('forecast-map').setView([-25.0, 135.0], 4);
                
                // Add the base tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(window.forecastMiniMap);
                
                // Add some forecast markers
                const forecastMarkers = [
                    { lat: -33.8688, lng: 151.2093, severity: 'high', day: 3 }, // Sydney
                    { lat: -37.8136, lng: 144.9631, severity: 'medium', day: 2 }, // Melbourne
                    { lat: -27.4698, lng: 153.0251, severity: 'high', day: 1 }, // Brisbane
                    { lat: -34.9285, lng: 138.6007, severity: 'low', day: 4 } // Adelaide
                ];
                
                forecastMarkers.forEach(marker => {
                    const color = marker.severity === 'high' ? '#dc3545' : marker.severity === 'medium' ? '#ffc107' : '#28a745';
                    
                    L.circleMarker([marker.lat, marker.lng], {
                        radius: 10,
                        fillColor: color,
                        color: '#000',
                        weight: 1,
                        fillOpacity: 0.8
                    }).bindPopup(`<strong>Day ${marker.day} Forecast</strong><br>Severity: ${marker.severity}`).addTo(window.forecastMiniMap);
                });
            }
            
            showToast('Weather charts initialized');
        }
        
        // Initialize Comparison Charts
        function initComparisonCharts() {
            // Run comparison when the run button is clicked
            document.getElementById('run-comparison').addEventListener('click', function() {
                runComparisonAnalysis();
            });
            
            // Add event listener for export comparison button if it exists
            const exportBtn = document.getElementById('export-comparison');
            if (exportBtn) {
                exportBtn.addEventListener('click', function() {
                    exportComparisonReport();
                });
            }
        }
        
        // Run comparison analysis and show results
        function runComparisonAnalysis() {
            // Get values from the selectors
            const scenarioARegion = document.getElementById('scenario-a-region').value;
            const scenarioARisk = document.getElementById('scenario-a-risk').value;
            const scenarioAClimate = document.getElementById('scenario-a-climate').value;
            
            const scenarioBRegion = document.getElementById('scenario-b-region').value;
            const scenarioBRisk = document.getElementById('scenario-b-risk').value;
            const scenarioBClimate = document.getElementById('scenario-b-climate').value;
            
            // Show results section
            document.querySelector('.comparison-results').style.display = 'block';
            
            // Create risk comparison chart
            const riskComparisonCtx = document.getElementById('risk-comparison-chart').getContext('2d');
            new Chart(riskComparisonCtx, {
                type: 'radar',
                data: {
                    labels: ['Flood', 'Cyclone', 'Storm', 'Landslide', 'Infrastructure', 'Economic'],
                    datasets: [{
                        label: 'Scenario A',
                        data: generateRiskData(scenarioARisk, scenarioAClimate),
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        pointBackgroundColor: 'rgba(54, 162, 235, 1)'
                    }, {
                        label: 'Scenario B',
                        data: generateRiskData(scenarioBRisk, scenarioBClimate),
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        pointBackgroundColor: 'rgba(255, 99, 132, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    }
                }
            });
            
            // Create financial impact chart
            const financialCtx = document.getElementById('financial-comparison-chart').getContext('2d');
            new Chart(financialCtx, {
                type: 'bar',
                data: {
                    labels: ['Property Damage', 'Business Interruption', 'Infrastructure', 'Response Costs', 'Insurance'],
                    datasets: [{
                        label: 'Scenario A ($ Millions)',
                        data: generateFinancialData(scenarioARegion, scenarioARisk, scenarioAClimate),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)'
                    }, {
                        label: 'Scenario B ($ Millions)',
                        data: generateFinancialData(scenarioBRegion, scenarioBRisk, scenarioBClimate),
                        backgroundColor: 'rgba(255, 99, 132, 0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cost ($ Millions)'
                            }
                        }
                    }
                }
            });
            
            // Create ESG impact chart
            const esgCtx = document.getElementById('esg-comparison-chart').getContext('2d');
            new Chart(esgCtx, {
                type: 'polarArea',
                data: {
                    labels: ['Environmental', 'Social', 'Governance'],
                    datasets: [{
                        data: generateESGData(scenarioAClimate, scenarioBClimate),
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            showToast('Comparison analysis completed');
        }
        
        // Helper function to generate risk data based on scenario
        function generateRiskData(riskLevel, climateScenario) {
            // Base values depend on risk level
            let baseValues = {
                low: [25, 20, 30, 15, 35, 40],
                medium: [45, 40, 50, 35, 55, 60],
                high: [65, 60, 70, 55, 75, 80]
            }[riskLevel] || [45, 40, 50, 35, 55, 60];
            
            // Adjust for climate scenario
            const multiplier = climateScenario === 'rcp85' ? 1.3 : 
                            climateScenario === 'rcp45' ? 1.15 : 1;
            
            // Add some randomness
            return baseValues.map(value => 
                Math.min(100, Math.round(value * multiplier * (0.9 + Math.random() * 0.2)))
            );
        }
        
        // Helper function to generate financial data
        function generateFinancialData(region, riskLevel, climateScenario) {
            // Base costs depend on region
            let baseCosts = {
                queensland: [110, 80, 95, 45, 120],
                nsw: [120, 105, 85, 50, 130],
                victoria: [90, 85, 75, 40, 100],
                nt: [60, 45, 80, 30, 70],
                wa: [80, 60, 90, 35, 85]
            }[region] || [100, 80, 85, 40, 110];
            
            // Risk multiplier
            const riskMultiplier = riskLevel === 'high' ? 1.5 :
                                riskLevel === 'medium' ? 1.0 : 0.7;
            
            // Climate scenario multiplier
            const climateMultiplier = climateScenario === 'rcp85' ? 1.4 : 
                                    climateScenario === 'rcp45' ? 1.2 : 1.0;
            
            // Apply multipliers and randomness
            return baseCosts.map(cost => 
                Math.round(cost * riskMultiplier * climateMultiplier * (0.9 + Math.random() * 0.2))
            );
        }
        
        // Helper function to generate ESG impact data
        function generateESGData(climateScenarioA, climateScenarioB) {
            // Determine the difference in climate scenarios
            const scenarioValueA = climateScenarioA === 'rcp85' ? 3 : 
                                climateScenarioA === 'rcp45' ? 2 : 1;
            
            const scenarioValueB = climateScenarioB === 'rcp85' ? 3 : 
                                climateScenarioB === 'rcp45' ? 2 : 1;
            
            // Calculate the differences
            const envImpact = Math.abs(scenarioValueA - scenarioValueB) * 30 + 40;
            const socialImpact = Math.abs(scenarioValueA - scenarioValueB) * 25 + 35;
            const govImpact = Math.abs(scenarioValueA - scenarioValueB) * 20 + 45;
            
            return [envImpact, socialImpact, govImpact];
        }
        
        // Export comparison report as PDF
        function exportComparisonReport() {
            showToast('Exporting comparison report as PDF...');
            // In production would use html2canvas and jsPDF to create a PDF
            setTimeout(() => {
                showToast('Comparison report exported!');
            }, 1500);
        }
    </script>
    <!-- JavaScript Libraries moved to head section -->
</body>
</html>